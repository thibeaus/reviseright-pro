<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#4f46e5">
<title>ReviseRight Pro</title>
<script src="https://cdn.tailwindcss.com"></script>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
-webkit-tap-highlight-color: transparent;
}
:root {
--bg-primary: #f7f9fb;
--bg-secondary: #ffffff;
--text-primary: #111827;
--text-secondary: #6b7280;
--accent: #4f46e5;
--accent-light: #818cf8;
--border: #e5e7eb;
--success: #10b981;
--warning: #f59e0b;
--danger: #ef4444;
--premium: #f59e0b;
--lifetime: #8b5cf6;
}
body.theme-dark {
--bg-primary: #1f2937;
--bg-secondary: #111827;
--text-primary: #f9fafb;
--text-secondary: #d1d5db;
--accent: #818cf8;
--accent-light: #a78bfa;
--border: #374151;
}

body.theme-dyslexia {
--bg-primary: #fef3c7;
--bg-secondary: #fffbeb;
--text-primary: #000000;
--text-secondary: #1f2937;
--accent: #059669;
--accent-light: #10b981;
--border: #fbbf24;
font-family: 'Comic Sans MS', Arial, sans-serif !important;
letter-spacing: 0.05em;
line-height: 1.8;
}
body.theme-blue {
--bg-primary: #dbeafe;
--bg-secondary: #eff6ff;
--text-primary: #1e3a8a;
--text-secondary: #1e40af;
--accent: #2563eb;
--accent-light: #3b82f6;
--border: #93c5fd;
}
body.theme-pink {
--bg-primary: #fce7f3;
--bg-secondary: #fef3f9;
--text-primary: #831843;
--text-secondary: #9f1239;
--accent: #db2777;
--accent-light: #ec4899;
--border: #f9a8d4;
}
body {
font-family: -apple-system, BlinkMacSystemFont, sans-serif;
background: var(--bg-primary);
color: var(--text-primary);
min-height: 100vh;
}
.hidden { display: none !important; }
.container {
max-width: 1200px;
margin: 0 auto;
padding: 20px;
}

.card {
background: var(--bg-secondary);
border: 1px solid var(--border);
border-radius: 12px;
padding: 20px;
margin-bottom: 20px;
}
.card-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
padding-bottom: 15px;
border-bottom: 2px solid var(--border);
}
button {
padding: 12px 20px;
border: none;
border-radius: 8px;
font-weight: 600;
cursor: pointer;
font-size: 14px;
transition: all 0.2s;
}
button:active { transform: scale(0.98); }
.btn-primary {
background: var(--accent);
color: white;
}
.btn-secondary {
background: var(--bg-primary);
color: var(--text-primary);
border: 1px solid var(--border);
}
.btn-success {
background: var(--success);
color: white;
}
.btn-danger {
background: var(--danger);
color: white;
}
.btn-premium {
background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
color: white;
}
.btn-lifetime {
background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
color: white;
box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
}
input, select, textarea {
width: 100%;
padding: 12px;
border: 1px solid var(--border);
border-radius: 8px;
background: var(--bg-primary);
color: var(--text-primary);
font-size: 16px;
margin-top: 8px;
}
.nav {
background: var(--bg-secondary);
border-bottom: 1px solid var(--border);
padding: 15px 20px;
display: flex;
gap: 10px;
overflow-x: auto;
}
.nav-btn {
padding: 10px 20px;
background: transparent;
color: var(--text-secondary);
border: none;
border-radius: 8px;
white-space: nowrap;
font-weight: 500;
}
.nav-btn.active {
background: var(--accent);
color: white;
}

/* NEW: Year tabs */
.year-tabs {
display: flex;
gap: 8px;
margin-bottom: 20px;
overflow-x: auto;
padding: 10px;
background: var(--bg-primary);
border-radius: 8px;
}
.year-tab {
padding: 8px 16px;
background: var(--bg-secondary);
border: 2px solid var(--border);
border-radius: 6px;
cursor: pointer;
white-space: nowrap;
font-weight: 500;
transition: all 0.2s;
}
.year-tab.active {
background: var(--accent);
color: white;
border-color: var(--accent);
}
/* NEW: Flashcard styles */
.flashcard {
width: 100%;
max-width: 500px;
height: 300px;
perspective: 1000px;
margin: 20px auto;
}
.flashcard-inner {
position: relative;
width: 100%;
height: 100%;
transition: transform 0.6s;
transform-style: preserve-3d;
}
.flashcard.flipped .flashcard-inner {
transform: rotateY(180deg);
}
.flashcard-front, .flashcard-back {
position: absolute;
width: 100%;
height: 100%;
backface-visibility: hidden;
border-radius: 12px;
border: 2px solid var(--border);
display: flex;
align-items: center;
justify-content: center;
padding: 30px;
font-size: 20px;
text-align: center;
background: var(--bg-secondary);
}
.flashcard-back {
transform: rotateY(180deg);
background: var(--accent-light);
color: white;
}
/* NEW: Pomodoro timer styles */
.timer-display {
font-size: 72px;
font-weight: bold;
text-align: center;
margin: 30px 0;
font-family: 'Courier New', monospace;
color: var(--accent);
}
.pet-container {
text-align: center;
margin: 30px 0;
}
.pet {
font-size: 100px;
display: inline-block;
animation: bounce 2s infinite;
}
@keyframes bounce {
0%, 100% { transform: translateY(0); }
50% { transform: translateY(-20px); }
}
.pet.studying {
animation: study-wiggle 1s infinite;
}
@keyframes study-wiggle {
0%, 100% { transform: rotate(-5deg); }
50% { transform: rotate(5deg); }
}
/* NEW: Exam countdown styles */
.exam-card {
padding: 15px;
background: var(--bg-primary);
border-left: 4px solid var(--accent);
border-radius: 8px;
margin-bottom: 12px;
}
.exam-card.urgent {
border-left-color: var(--danger);
background: #fee;
}
.exam-card.soon {
border-left-color: var(--warning);
background: #fffaeb;
}
.countdown {
font-size: 24px;
font-weight: bold;
color: var(--accent);
}
.grade-badge {
display: inline-block;
padding: 6px 14px;
border-radius: 6px;
font-weight: bold;
font-size: 13px;
margin: 3px;
}
.grade-9 { background: #10b981; color: white; }
.grade-8 { background: #3b82f6; color: white; }
.grade-7 { background: #8b5cf6; color: white; }
.grade-6 { background: #f59e0b; color: white; }
.grade-5 { background: #ef4444; color: white; }
.grade-4 { background: #dc2626; color: white; }
.grade-3 { background: #991b1b; color: white; }
.grade-2 { background: #7f1d1d; color: white; }
.grade-1 { background: #6b7280; color: white; }
.grade-U { background: #374151; color: white; }
.stat-card {
background: var(--bg-primary);
border: 2px solid var(--border);
border-radius: 12px;
padding: 20px;
text-align: center;
}
.stat-value {
font-size: 36px;
font-weight: bold;
color: var(--accent);
margin-bottom: 8px;
}
.stat-label {
color: var(--text-secondary);
font-size: 14px;
font-weight: 500;
}
.p8-slot {
background: var(--bg-primary);
border: 2px solid var(--border);
border-radius: 10px;
padding: 15px;
margin-bottom: 12px;
}
.p8-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 12px;
padding-bottom: 10px;
border-bottom: 1px solid var(--border);
}
.points-badge {
display: inline-block;
padding: 4px 10px;
border-radius: 6px;
font-size: 12px;
font-weight: bold;
}
.points-positive { background: #10b981; color: white; }
.points-neutral { background: #6b7280; color: white; }
.points-negative { background: #ef4444; color: white; }

.modal {
display: none;
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.5);
z-index: 1000;
align-items: center;
justify-content: center;
overflow-y: auto;
}
.modal.show { display: flex; }
.modal-content {
background: var(--bg-secondary);
border-radius: 12px;
padding: 25px;
max-width: 1000px;
width: 90%;
max-height: 90vh;
overflow-y: auto;
margin: 20px;
}
.teacher-badge {
background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
color: white;
padding: 4px 12px;
border-radius: 6px;
font-size: 12px;
font-weight: bold;
}
.premium-badge {
background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
color: white;
padding: 4px 12px;
border-radius: 6px;
font-size: 12px;
font-weight: bold;
display: inline-flex;
align-items: center;
gap: 4px;
}

.lifetime-badge {
background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
color: white;
padding: 4px 12px;
border-radius: 6px;
font-size: 12px;
font-weight: bold;
display: inline-flex;
align-items: center;
gap: 4px;
}
.student-row {
background: var(--bg-primary);
border: 1px solid var(--border);
border-radius: 8px;
padding: 12px;
margin-bottom: 8px;
display: flex;
justify-content: space-between;
align-items: center;
}
.pricing-card {
background: var(--bg-secondary);
border: 3px solid var(--border);
border-radius: 16px;
padding: 30px;
text-align: center;
position: relative;
transition: transform 0.2s;
}
.pricing-card:hover {
transform: translateY(-5px);
}
.pricing-card.featured {
border-color: var(--accent);
box-shadow: 0 10px 40px rgba(79, 70, 229, 0.2);
}
.pricing-card.best-value {
border-color: var(--lifetime);
box-shadow: 0 10px 40px rgba(139, 92, 246, 0.3);
transform: scale(1.05);
}

.pricing-badge {
position: absolute;
top: -12px;
right: 20px;
background: var(--accent);
color: white;
padding: 6px 16px;
border-radius: 20px;
font-size: 12px;
font-weight: bold;
}
.best-value-badge {
position: absolute;
top: -12px;
right: 20px;
background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
color: white;
padding: 6px 16px;
border-radius: 20px;
font-size: 12px;
font-weight: bold;
}
.savings-label {
background: #10b981;
color: white;
padding: 4px 10px;
border-radius: 6px;
font-size: 11px;
font-weight: bold;
display: inline-block;
margin-top: 10px;
}
@media (max-width: 768px) {
.container { padding: 10px; }
.stat-card { padding: 15px; }
.stat-value { font-size: 28px; }
.pricing-card.best-value { transform: scale(1); }
}

/* PHASE 2: ACHIEVEMENTS & NOTIFICATIONS */
.notification-banner {
  background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
  color: white;
  padding: 15px 20px;
  border-radius: 10px;
  margin-bottom: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  animation: slideIn 0.3s ease-out;
  box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
}
.notification-banner.warning {
  background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
}
.notification-banner.success {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}
@keyframes slideIn {
  from { transform: translateY(-20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
.achievement-badge {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 15px 20px;
  background: var(--bg-secondary);
  border: 3px solid var(--accent);
  border-radius: 12px;
  margin: 10px;
  transition: all 0.3s;
  cursor: pointer;
}
.achievement-badge:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);
}
.achievement-badge.locked {
  opacity: 0.4;
  border-color: var(--border);
  cursor: not-allowed;
}
.achievement-badge.locked:hover {
  transform: none;
  box-shadow: none;
}
.achievement-icon {
  font-size: 32px;
}
.achievement-info h4 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
}
.achievement-info p {
  margin: 5px 0 0 0;
  font-size: 13px;
  color: var(--text-secondary);
}
.achievement-progress {
  width: 100%;
  height: 6px;
  background: var(--border);
  border-radius: 3px;
  margin-top: 8px;
  overflow: hidden;
}
.achievement-progress-bar {
  height: 100%;
  background: var(--accent);
  border-radius: 3px;
  transition: width 0.3s;
}
.unlock-animation {
  animation: unlock 0.6s ease-out;
}
@keyframes unlock {
  0% { transform: scale(0.8) rotate(-10deg); opacity: 0; }
  50% { transform: scale(1.1) rotate(5deg); }
  100% { transform: scale(1) rotate(0deg); opacity: 1; }
}
</style>
</head>
<body>
<!-- Loading Screen -->
<div id="loadingScreen" style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
<div style="text-align: center; color: white;">
<div style="font-size: 60px; margin-bottom: 20px;">📚</div>
<h2 style="font-size: 32px; margin-bottom: 10px;">ReviseRight Pro</h2>
<p>Loading...</p>
</div>
</div>

<!-- Auth Screen -->
<div id="authScreen" class="hidden" style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px;">
<div style="background: white; border-radius: 20px; padding: 40px; max-width: 400px; width: 100%;">
<div style="text-align: center; margin-bottom: 30px;">
<div style="font-size: 50px; margin-bottom: 15px;">📚</div>
<h1 style="font-size: 32px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ReviseRight Pro</h1>
<p style="color: #666; margin-top: 10px;">Your complete study companion</p>
</div>
<div id="messageBox"></div>
<!-- Account Type Selection -->
<div id="accountTypeSelection">
<h3 style="margin-bottom: 20px; text-align: center; color: #333;">Choose Account Type</h3>
<button onclick="selectAccountType('student')" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px; border-radius: 10px; font-weight: bold; margin-bottom: 10px;">
📚 Student Account
</button>
<button onclick="selectAccountType('teacher')" style="width: 100%; background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%); color: white; padding: 16px; border-radius: 10px; font-weight: bold;">
👨‍🏫 Teacher Account
</button>
<p style="text-align: center; margin-top: 15px; color: #666; font-size: 14px;">
Have an account? <a onclick="showLogin()" style="color: #667eea; font-weight: bold; cursor: pointer;">Sign In</a>
</p>
</div>
<!-- Login Form -->
<div id="loginForm" class="hidden">
<h2 style="margin-bottom: 20px; color: #333;">Sign In</h2>
<div style="margin-bottom: 15px;">
<label style="display: block; color: #666; margin-bottom: 5px;">Email</label>
<input type="email" id="loginEmail" placeholder="your@email.com" style="border: 1px solid #ddd;">
</div>
<div style="margin-bottom: 15px;">
<label style="display: block; color: #666; margin-bottom: 5px;">Password</label>
<input type="password" id="loginPassword" placeholder="••••••••" style="border: 1px solid #ddd;">
</div>
<button onclick="handleLogin()" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 14px; border-radius: 10px; font-weight: bold; margin-top: 10px;">Sign In</button>
<p style="text-align: center; margin-top: 15px; color: #666; font-size: 14px;">
<a onclick="showAccountType()" style="color: #667eea; font-weight: bold; cursor: pointer;">← Back</a>
</p>
</div>
<!-- Signup Form -->
<div id="signupForm" class="hidden">
<h2 style="margin-bottom: 20px; color: #333;">Create <span id="accountTypeLabel">Student</span> Account</h2>
<div style="margin-bottom: 15px;">
<label style="display: block; color: #666; margin-bottom: 5px;">Name</label>
<input type="text" id="signupName" placeholder="Your name" style="border: 1px solid #ddd;">
</div>
<div style="margin-bottom: 15px;">
<label style="display: block; color: #666; margin-bottom: 5px;">Email</label>
<input type="email" id="signupEmail" placeholder="your@email.com" style="border: 1px solid #ddd;">
</div>
<div style="margin-bottom: 15px;">
<label style="display: block; color: #666; margin-bottom: 5px;">Password</label>
<input type="password" id="signupPassword" placeholder="At least 6 characters" style="border: 1px solid #ddd;">
</div>
<div id="teacherFields" class="hidden" style="margin-bottom: 15px;">
<label style="display: block; color: #666; margin-bottom: 5px;">School Name</label>
<input type="text" id="schoolName" placeholder="Your school" style="border: 1px solid #ddd;">
</div>
<div id="studentFields" class="hidden" style="margin-bottom: 15px;">
<label style="display: block; color: #666; margin-bottom: 5px;">Current Study Level</label>
<select id="studyLevel" style="border: 1px solid #ddd;">
<option value="gcse">GCSE (Free)</option>
<option value="alevel">A-Level (Premium)</option>
<option value="university">University (Premium)</option>
</select>
</div>

<div style="margin-bottom: 15px;">
<label style="display: block; color: #666; margin-bottom: 5px;">Teacher's Class Code (Optional)</label>
<input type="text" id="signupClassCode" placeholder="e.g., SMITH-MATH-Y11-X4K2" style="border: 1px solid #ddd; text-transform: uppercase;">
<p style="font-size: 12px; color: #999; margin-top: 5px;">Have a code from your teacher? Enter it here to link your account.</p>
</div>

<button onclick="handleSignup()" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 14px; border-radius: 10px; font-weight: bold; margin-top: 10px;">Create Account</button>
<p style="text-align: center; margin-top: 15px; color: #666; font-size: 14px;">
<a onclick="showAccountType()" style="color: #667eea; font-weight: bold; cursor: pointer;">← Back</a>
</p>
</div>
</div>
</div>

<!-- Main App -->
<div id="app" class="hidden">
<!-- Navigation -->
<div class="nav">
<button class="nav-btn active" onclick="switchTab('dashboard')">📊 Dashboard</button>
<button class="nav-btn" onclick="switchTab('progress8')" id="progress8Nav">🎯 Progress 8</button>
<button class="nav-btn hidden" id="teacherTab" onclick="switchTab('teacher')">👨‍🏫 Students</button>
<button class="nav-btn" id="studentTab" onclick="switchTab('subjects')">📚 Subjects</button>
<button class="nav-btn" id="topicsTab" onclick="switchTab('topics')">📝 Topics</button>
<button class="nav-btn" onclick="switchTab('flashcards')">🎴 Flashcards</button>
<button class="nav-btn" onclick="switchTab('pomodoro')">⏱ Timer</button>
<button class="nav-btn" onclick="switchTab('exams')">📅 Exams</button>
<button class="nav-btn" id="scheduleTab" onclick="switchTab('schedule')">📆 Schedule</button>
    <button class="nav-btn" onclick="switchTab('achievements')">🏆 Achievements</button>
    <button class="nav-btn" onclick="switchTab('settings')">⚙ Settings</button>
</div>

<div class="container">
    <!-- Notifications Banner -->
    <div id="notificationsBanner"></div>

    
<!-- NEW: Year Selector (Shows for students only) -->
<div id="yearSelector" class="hidden">
<div class="year-tabs" id="yearTabs"></div>
</div>

<!-- Student Dashboard -->
<div id="dashboardTab">
<div class="card">
<h2 style="margin-bottom: 10px;">Welcome back, <span id="userName"></span>!
<span id="teacherBadge" class="hidden teacher-badge">TEACHER</span>
<span id="premiumBadge" class="hidden premium-badge">⭐ PREMIUM</span>
<span id="lifetimeBadge" class="hidden lifetime-badge">♾ LIFETIME</span>
</h2>
<p style="color: var(--text-secondary);">Here's your study overview</p>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
<div class="stat-card">
<div class="stat-value" id="subjectCount">0</div>
<div class="stat-label">Subjects</div>
</div>
<div class="stat-card">
<div class="stat-value" id="topicCount">0</div>
<div class="stat-label">Topics</div>
</div>
<div class="stat-card">
<div class="stat-value" id="flashcardCount">0</div>
<div class="stat-label">Flashcards</div>
</div>
<div class="stat-card">
<div class="stat-value" id="examCount">0</div>
<div class="stat-label">Upcoming Exams</div>
</div>
</div>


<div class="card">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
<h3>👨‍🏫 Your Linked Teachers</h3>
<button class="btn-primary" onclick="showLinkTeacher()">+ Link Teacher</button>
</div>
<div id="linkedTeachersList"></div>
</div>

<div class="card">
<h3 style="margin-bottom: 15px;">📚 Recent Subjects</h3>
<div id="recentSubjects"></div>
</div>

<!-- Upgrade prompt -->
<div id="upgradePrompt" class="hidden card" style="background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); color: white; text-align: center;">
<h3 style="margin-bottom: 10px;">🌟 Unlock Lifetime Access</h3>
<p style="margin-bottom: 20px; opacity: 0.9;">Get unlimited access to GCSE, A-Level & University tools for life!</p>
<button onclick="switchTab('settings')" style="background: white; color: #8b5cf6; padding: 12px 30px; border-radius: 8px; font-weight: bold;">View Plans</button>
</div>
</div>

<!-- Teacher Dashboard -->
<div id="teacherDashboard" class="hidden">
<div class="card">
<h2 style="margin-bottom: 10px;">👨‍🏫 Teacher Overview - <span id="teacherName"></span></h2>
<p style="color: var(--text-secondary);"><span id="teacherSchoolName"></span></p>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px;">
<div class="stat-card" style="border-color: var(--accent);">
<div class="stat-value" id="teacherStudentCount">0</div>
<div class="stat-label">Total Students</div>
</div>
<div class="stat-card">
<div class="stat-value" id="teacherYear10Count">0</div>
<div class="stat-label">Year 10</div>
</div>
<div class="stat-card">
<div class="stat-value" id="teacherYear11Count">0</div>
<div class="stat-label">Year 11</div>
</div>
<div class="stat-card">
<div class="stat-value" id="teacherAvgP8">0.00</div>
<div class="stat-label">Average P8</div>
</div>
</div>

<div class="card">
<h3 style="margin-bottom: 15px;">📊 Class Performance</h3>
<div id="classPerformance"></div>
</div>


<div class="card">
<div class="card-header">
<h2>📋 Your Class Codes</h2>
<button class="btn-primary" onclick="showCreateClassCode()">+ Create New Code</button>
</div>

<p style="color: var(--text-secondary); margin-bottom: 20px;">Share these codes with students so they can link to you and you can view their progress.</p>

<div id="classCodesList"></div>
</div>

<div class="card">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
<h3>👥 Recent Students</h3>
<button class="btn-primary" onclick="switchTab('teacher')">View All</button>
</div>
<div id="recentStudents"></div>
</div>
</div>

<!-- Progress 8 Tab -->
<div id="progress8Tab" class="hidden">
<div class="card">
<div class="card-header">
<div>
<h2 style="margin-bottom: 5px;">🎯 Progress 8 Tracker</h2>
<p style="color: var(--text-secondary); font-size: 14px;">Track your GCSE grades with the official Progress 8 points system</p>
</div>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px;">
<div class="stat-card" style="border: 3px solid var(--accent);">
<div class="stat-value" id="p8Score">0.00</div>
<div class="stat-label">Progress 8 Score</div>
</div>
<div class="stat-card">
<div class="stat-value" id="avgTarget">0.0</div>
<div class="stat-label">Avg Target Grade</div>
</div>
<div class="stat-card">
<div class="stat-value" id="avgCurrent">0.0</div>
<div class="stat-label">Avg Current Grade</div>
</div>
<div class="stat-card">
<div class="stat-value" id="totalPoints">0</div>
<div class="stat-label">Total Points</div>
</div>
</div>

<div style="background: var(--bg-primary); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
<h4 style="margin-bottom: 10px; font-size: 14px; color: var(--text-secondary);">📊 Grade Points Reference:</h4>
<div style="display: flex; flex-wrap: wrap; gap: 8px;">
<span class="grade-badge grade-9">9 = 9pts</span>
<span class="grade-badge grade-8">8 = 8pts</span>
<span class="grade-badge grade-7">7 = 7pts</span>
<span class="grade-badge grade-6">6 = 6pts</span>
<span class="grade-badge grade-5">5 = 5pts</span>
<span class="grade-badge grade-4">4 = 4pts</span>
<span class="grade-badge grade-3">3 = 3pts</span>
<span class="grade-badge grade-2">2 = 2pts</span>
<span class="grade-badge grade-1">1 = 1pt</span>
<span class="grade-badge grade-U">U = 0pts</span>
</div>
</div>

<div id="progress8List"></div>
</div>
</div>

<!-- Teacher Students Tab -->
<div id="teacherTabContent" class="hidden">
<div class="card">
<div class="card-header">
<div>
<h2>👨‍🏫 Student Management</h2>
<p style="color: var(--text-secondary); font-size: 14px;">Manage Year 10 & 11 students</p>
</div>
<button class="btn-primary" onclick="showAddStudent()">+ Add Student</button>
</div>
<div id="studentsList"></div>
</div>
</div>

<!-- Subjects Tab -->
<div id="subjectsTab" class="hidden">
<div class="card">
<div class="card-header">
<h2>📚 My Subjects</h2>
<button class="btn-primary" onclick="showAddSubject()">+ Add Subject</button>
</div>
<div id="subjectsList"></div>
</div>
</div>

<!-- Topics Tab -->
<div id="topicsTab" class="hidden">
<div class="card">
<div class="card-header">
<h2>📝 Study Topics</h2>
<button class="btn-primary" onclick="showAddTopic()">+ Add Topic</button>
</div>
<div id="topicsList"></div>
</div>
</div>

<!-- Schedule Tab -->
<div id="scheduleTab" class="hidden">
<div class="card">
<div class="card-header">
<h2>📅 Study Schedule</h2>
<button class="btn-primary" onclick="showAddSchedule()">+ Add Session</button>
</div>
<div id="scheduleList"></div>
</div>
</div>

<!-- NEW: Flashcards Tab -->
<div id="flashcardsTab" class="hidden">
<div class="card">
<div class="card-header">
<h2>🎴 Flashcards</h2>
<div style="display: flex; gap: 10px;">
<button class="btn-secondary" onclick="showStudyMode()" id="studyModeBtn" style="display: none;">📖 Study Mode</button>
<button class="btn-primary" onclick="showAddFlashcard()">+ Add Flashcard</button>
</div>
</div>

<!-- Study Mode -->
<div id="studyMode" class="hidden">
<div style="text-align: center; margin-bottom: 20px;">
<h3>Study Mode</h3>
<p style="color: var(--text-secondary);">Card <span id="currentCardNum">1</span> of <span id="totalCards">0</span></p>
</div>

<div class="flashcard" id="flashcard" onclick="flipCard()">
<div class="flashcard-inner">
<div class="flashcard-front">
<div id="cardFront">Click to reveal</div>
</div>
<div class="flashcard-back">
<div id="cardBack">Answer</div>
</div>
</div>
</div>

<div id="cardFeedback" style="text-align: center; margin-top: 15px; font-weight: 600; min-height: 20px;"></div>
        
        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap;">
          <button class="btn-danger" onclick="markWrong()">✗ Got it Wrong</button>
          <button class="btn-secondary" onclick="prevCard()">← Previous</button>
          <button class="btn-success" onclick="markMastered()">✓ Mastered</button>
          <button class="btn-primary" onclick="nextCard()">Next →</button>
          <button class="btn-secondary" onclick="exitStudyMode()">Exit Study</button>
        </div>
</div>

<!-- Flashcard List -->
<div id="flashcardList"></div>
</div>
</div>

<!-- NEW: Pomodoro Timer Tab -->
<div id="pomodoroTab" class="hidden">
<div class="card">
<div class="card-header">
<h2>⏱ Pomodoro Study Timer</h2>
</div>

<div style="text-align: center;">
<div class="timer-display" id="timerDisplay">25:00</div>

<div class="pet-container">
<div class="pet" id="studyPet">🌱</div>
<p style="margin-top: 10px; font-weight: 600;" id="petStatus">Water me by studying!</p>
</div>

<div style="display: flex; gap: 10px; justify-content: center; margin: 20px 0;">
<button class="btn-primary" id="startBtn" onclick="startTimer()">▶ Start</button>
<button class="btn-secondary" id="pauseBtn" onclick="pauseTimer()" style="display: none;">⏸ Pause</button>
<button class="btn-secondary" onclick="resetTimer()">🔄 Reset</button>
</div>

<div style="background: var(--bg-primary); padding: 20px; border-radius: 12px; margin-top: 20px;">
<h3 style="margin-bottom: 15px;">📊 Your Progress</h3>
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
<div>
<div style="font-size: 32px; font-weight: bold; color: var(--accent);" id="sessionsToday">0</div>
<div style="font-size: 14px; color: var(--text-secondary);">Sessions Today</div>
</div>
<div>
<div style="font-size: 32px; font-weight: bold; color: var(--success);" id="studyStreak">0</div>
<div style="font-size: 14px; color: var(--text-secondary);">Day Streak</div>
</div>
<div>
<div style="font-size: 32px; font-weight: bold; color: var(--warning);" id="totalCoins">0</div>
<div style="font-size: 14px; color: var(--text-secondary);">Study Coins</div>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- NEW: Exams Tab -->
<div id="examsTab" class="hidden">
<div class="card">
<div class="card-header">
<h2>📅 Exam Countdown</h2>
<button class="btn-primary" onclick="showAddExam()">+ Add Exam</button>
</div>
<div id="examsList"></div>
</div>
</div>


<!-- Achievements Tab (PHASE 2) -->
<div id="achievementsTab" class="hidden">
  <div class="card">
    <div class="card-header">
      <h2>🏆 Your Achievements</h2>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
      <div class="stat-card">
        <div class="stat-value" id="totalAchievements">0</div>
        <div class="stat-label">Achievements Unlocked</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="achievementXP">0</div>
        <div class="stat-label">Total XP</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="achievementStreak">0</div>
        <div class="stat-label">Current Streak</div>
      </div>
    </div>

    <h3 style="margin-bottom: 15px;">🎯 All Achievements</h3>
    <div id="achievementsList"></div>
  </div>
</div>

<!-- Settings Tab -->
<div id="settingsTab" class="hidden">
<div class="card">
<h2 style="margin-bottom: 20px;">⚙ Settings</h2>

<!-- Subscription Section -->
<div id="subscriptionSection" style="background: var(--bg-primary); border-radius: 10px; padding: 20px; margin-bottom: 25px;">
<h3 style="margin-bottom: 15px;">💎 Your Plan</h3>
<div id="currentPlan" style="margin-bottom: 15px;"></div>
<div id="planDetails" style="margin-bottom: 15px;"></div>
<button id="upgradeButton" onclick="showUpgradeModal()" class="btn-premium" style="display: none;">⭐ Upgrade Plan</button>
</div>

<!-- Account Info -->
<div style="background: var(--bg-primary); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
<h3 style="margin-bottom: 15px; font-weight: 600;">📋 Account Information</h3>
<div style="margin-bottom: 12px;">
<label style="display: block; color: var(--text-secondary); font-size: 14px; margin-bottom: 5px;">Account Type</label>
<div id="accountTypeDisplay" style="padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; font-weight: 600;"></div>
</div>

<div id="schoolNameField" class="hidden" style="margin-bottom: 12px;">
<label style="display: block; color: var(--text-secondary); font-size: 14px; margin-bottom: 5px;">School Name</label>
<input type="text" id="settingsSchoolName" placeholder="Your school" onchange="updateSchoolName()" style="padding: 10px;">
</div>

<div id="studyLevelField" class="hidden" style="margin-bottom: 12px;">
<label style="display: block; color: var(--text-secondary); font-size: 14px; margin-bottom: 5px;">Study Level</label>
<select id="settingsStudyLevel" onchange="updateStudyLevel()" style="padding: 10px;">
<option value="gcse">GCSE</option>
<option value="alevel">A-Level</option>
<option value="university">University</option>
</select>
</div>
</div>

<div style="margin-bottom: 25px;">
<label style="display: block; margin-bottom: 10px; font-weight: 600;">Theme</label>
<select id="themeSelect" onchange="changeTheme()" style="width: 100%;">
<option value="default">Default (Light)</option>
<option value="dark">Dark Mode</option>
<option value="blue">Blue Theme</option>
<option value="pink">Pink Theme</option>
<option value="dyslexia">Dyslexia Friendly</option>
</select>
</div>

<div style="margin-bottom: 25px;">
<label style="display: block; margin-bottom: 10px; font-weight: 600;">Font Size</label>
<select id="fontSelect" onchange="changeFontSize()" style="width: 100%;">
<option value="14px">Small</option>
<option value="16px" selected>Medium</option>
<option value="18px">Large</option>
<option value="20px">Extra Large</option>
</select>
</div>

<button class="btn-secondary" onclick="logout()" style="width: 100%; margin-top: 20px;">Sign Out</button>
</div>
</div>
</div>
</div>

<!-- Modals -->
<div id="upgradeModal" class="modal">
<div class="modal-content">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
<h2>⭐ Choose Your Plan</h2>
<button onclick="closeModal('upgradeModal')" style="background: transparent; color: var(--text-secondary); padding: 8px;">✕</button>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;">
<!-- GCSE Free -->
<div class="pricing-card">
<h3 style="margin-bottom: 10px;">GCSE</h3>
<div style="font-size: 36px; font-weight: bold; margin: 20px 0;">FREE</div>
<div style="text-align: left; margin: 20px 0;">
<div style="padding: 8px 0;">✅ Progress 8 Tracker</div>
<div style="padding: 8px 0;">✅ Subject Management</div>
<div style="padding: 8px 0;">✅ Study Schedule</div>
<div style="padding: 8px 0;">✅ All Themes</div>
</div>
<button class="btn-secondary" disabled style="width: 100%; opacity: 0.6;">Current Plan</button>
</div>

<!-- A-Level Monthly -->
<div class="pricing-card featured">
<div class="pricing-badge">POPULAR</div>
<h3 style="margin-bottom: 10px;">A-Level</h3>
<div style="font-size: 36px; font-weight: bold; margin: 20px 0;">£4.99<span style="font-size: 16px;">/mo</span></div>
<div style="text-align: left; margin: 20px 0;">
<div style="padding: 8px 0;">✅ Everything in GCSE</div>
<div style="padding: 8px 0;">⭐ A-Level Subjects</div>
<div style="padding: 8px 0;">⭐ Advanced Analytics</div>
<div style="padding: 8px 0;">⭐ Exam Predictions</div>
</div>
<button class="btn-premium" onclick="upgradePlan('alevel', false)" style="width: 100%;">Upgrade to A-Level</button>
</div>

<!-- University Monthly -->
<div class="pricing-card featured">
<h3 style="margin-bottom: 10px;">University</h3>
<div style="font-size: 36px; font-weight: bold; margin: 20px 0;">£7.99<span style="font-size: 16px;">/mo</span></div>
<div style="text-align: left; margin: 20px 0;">
<div style="padding: 8px 0;">✅ Everything in A-Level</div>
<div style="padding: 8px 0;">⭐ University Modules</div>
<div style="padding: 8px 0;">⭐ Research Tools</div>
<div style="padding: 8px 0;">⭐ Citation Manager</div>
</div>
<button class="btn-premium" onclick="upgradePlan('university', false)" style="width: 100%;">Upgrade to University</button>
</div>

<!-- ALL ACCESS LIFETIME -->
<div class="pricing-card best-value">
<div class="best-value-badge">⭐ BEST VALUE</div>
<h3 style="margin-bottom: 10px; color: var(--lifetime);">♾ All Access Lifetime</h3>
<div style="font-size: 36px; font-weight: bold; margin: 20px 0; background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
£49.99<span style="font-size: 16px;">once</span>
</div>
<div class="savings-label">💰 Save £145+ per year!</div>
<div style="text-align: left; margin: 20px 0;">
<div style="padding: 8px 0; font-weight: 600;">✅ EVERYTHING INCLUDED:</div>
<div style="padding: 8px 0;">🎓 GCSE Tools</div>
<div style="padding: 8px 0;">🎓 A-Level Tools</div>
<div style="padding: 8px 0;">🎓 University Tools</div>
<div style="padding: 8px 0;">♾ Lifetime Access</div>
<div style="padding: 8px 0;">⚡ All Future Updates</div>
<div style="padding: 8px 0;">🌟 Priority Support</div>
</div>
<button class="btn-lifetime" onclick="upgradePlan('lifetime', true)" style="width: 100%;">🚀 Get Lifetime Access</button>
<p style="font-size: 12px; color: var(--text-secondary); margin-top: 10px;">✅ One-time payment • Use throughout your entire studies</p>
</div>
</div>

<div style="text-align: center; margin-top: 30px; padding: 20px; background: var(--bg-primary); border-radius: 10px;">
<p style="font-size: 14px; color: var(--text-secondary);">💳 Secure payment • Monthly plans cancel anytime • 7-day money-back guarantee</p>
</div>
</div>
</div>

<div id="addSubjectModal" class="modal">
<div class="modal-content">
<h3 style="margin-bottom: 20px;">Add Subject</h3>
<div style="margin-bottom: 15px;">
<label>Subject Name</label>
<input type="text" id="subjectName" placeholder="e.g., Mathematics">
</div>
<div style="margin-bottom: 15px;">
<label>Teacher</label>
<input type="text" id="subjectTeacher" placeholder="e.g., Mr. Smith">
</div>
<div style="margin-bottom: 15px;">
<label>Target Grade</label>
<select id="subjectTarget">
<option value="">Select grade...</option>
<option value="9">9</option><option value="8">8</option><option value="7">7</option><option value="6">6</option><option value="5">5</option><option value="4">4</option>
</select>
</div>

<div style="margin-bottom: 15px;">
<label>Exam Tier (Optional)</label>
<select id="subjectTier">
<option value="">Not specified</option>
<option value="Higher">Higher Tier (Grades 4-9)</option>
<option value="Foundation">Foundation Tier (Grades 1-5)</option>
</select>
<p style="font-size: 12px; color: #999; margin-top: 5px;">
For subjects with tiered exams (Maths, Science, etc.)
</p>
</div>

<div style="display: flex; gap: 10px; margin-top: 20px;">
<button class="btn-primary" onclick="addSubject()" style="flex: 1;">Add</button>
<button class="btn-secondary" onclick="closeModal('addSubjectModal')" style="flex: 1;">Cancel</button>
</div>
</div>
</div>

<div id="addTopicModal" class="modal">
<div class="modal-content">
<h3 style="margin-bottom: 20px;">Add Topic</h3>
<div style="margin-bottom: 15px;">
<label>Subject</label>
<select id="topicSubject"></select>
</div>
<div style="margin-bottom: 15px;">
<label>Topic Name</label>
<input type="text" id="topicName" placeholder="e.g., Quadratic Equations">
</div>
<div style="margin-bottom: 15px;">
<label>Confidence</label>
<select id="topicConfidence">
<option value="low">😟 Low</option>
<option value="medium">😐 Medium</option>
<option value="high">😊 High</option>
</select>
</div>
<div style="display: flex; gap: 10px; margin-top: 20px;">
<button class="btn-primary" onclick="addTopic()" style="flex: 1;">Add</button>
<button class="btn-secondary" onclick="closeModal('addTopicModal')" style="flex: 1;">Cancel</button>
</div>
</div>
</div>

<div id="addScheduleModal" class="modal">
<div class="modal-content">
<h3 style="margin-bottom: 20px;">Add Study Session</h3>
<div style="margin-bottom: 15px;">
<label>Subject</label>
<select id="scheduleSubject"></select>
</div>
<div style="margin-bottom: 15px;">
<label>Date</label>
<input type="date" id="scheduleDate">
</div>
<div style="margin-bottom: 15px;">
<label>Time</label>
<input type="time" id="scheduleTime">
</div>
<div style="margin-bottom: 15px;">
<label>Duration (minutes)</label>
<input type="number" id="scheduleDuration" placeholder="60">
</div>
<div style="display: flex; gap: 10px; margin-top: 20px;">
<button class="btn-primary" onclick="addSchedule()" style="flex: 1;">Add</button>
<button class="btn-secondary" onclick="closeModal('addScheduleModal')" style="flex: 1;">Cancel</button>
</div>
</div>
</div>

<div id="addStudentModal" class="modal">
<div class="modal-content">
<h3 style="margin-bottom: 20px;">Add Student</h3>
<div style="margin-bottom: 15px;">
<label>Student Name</label>
<input type="text" id="studentName" placeholder="Full name">
</div>
<div style="margin-bottom: 15px;">
<label>Year Group</label>
<select id="studentYear">
<option value="10">Year 10</option>
<option value="11">Year 11</option>
</select>
</div>
<div style="margin-bottom: 15px;">
<label>Student Email (optional)</label>
<input type="email" id="studentEmail" placeholder="student@school.com">
</div>
<div style="display: flex; gap: 10px; margin-top: 20px;">
<button class="btn-primary" onclick="addStudent()" style="flex: 1;">Add</button>
<button class="btn-secondary" onclick="closeModal('addStudentModal')" style="flex: 1;">Cancel</button>
</div>
</div>
</div>

<div id="viewStudentModal" class="modal">
<div class="modal-content">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h3 id="studentModalName">Student Progress 8</h3>
<button onclick="closeModal('viewStudentModal')" style="background: transparent; color: var(--text-secondary); padding: 8px;">✕</button>
</div>
<div id="studentP8Content"></div>
</div>
</div>

<div id="viewStudentTiersModal" class="modal">
<div class="modal-content">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h3>📊 Student Exam Tiers - <span id="tiersClassName"></span></h3>
<button onclick="closeModal('viewStudentTiersModal')" style="background: transparent; color: var(--text-secondary); padding: 8px;">✕</button>
</div>

<p style="color: var(--text-secondary); margin-bottom: 20px;">
View which tier each student is taking for this subject. Students can set their own tiers in their Progress 8 tracker.
</p>

<div id="studentTiersList"></div>

<div style="margin-top: 20px; padding: 15px; background: var(--bg-primary); border-radius: 8px;">
<h4 style="margin-bottom: 10px; font-size: 14px;">📋 Tier Information:</h4>
<div style="font-size: 13px; color: var(--text-secondary);">
<strong>Higher Tier:</strong> Grades 4-9 available<br>
<strong>Foundation Tier:</strong> Grades 1-5 available (max grade 5)
</div>
</div>

<button class="btn-secondary" onclick="closeModal('viewStudentTiersModal')" style="width: 100%; margin-top: 20px;">Close</button>
</div>
</div>

<div id="addFlashcardModal" class="modal">
<div class="modal-content">
<h3 style="margin-bottom: 20px;">Add Flashcard</h3>
<div style="margin-bottom: 15px;">
<label>Subject</label>
<select id="flashcardSubject"></select>
</div>
<div style="margin-bottom: 15px;">
<label>Front (Question)</label>
<textarea id="flashcardFront" rows="3" placeholder="What is...?"></textarea>
</div>
<div style="margin-bottom: 15px;">
<label>Back (Answer)</label>
<textarea id="flashcardBack" rows="3" placeholder="The answer is..."></textarea>
</div>
<div style="display: flex; gap: 10px; margin-top: 20px;">
<button class="btn-primary" onclick="addFlashcard()" style="flex: 1;">Add</button>
<button class="btn-secondary" onclick="closeModal('addFlashcardModal')" style="flex: 1;">Cancel</button>
</div>
</div>
</div>

<div id="addExamModal" class="modal">
<div class="modal-content">
<h3 style="margin-bottom: 20px;">Add Exam</h3>
<div style="margin-bottom: 15px;">
<label>Subject</label>
<select id="examSubject"></select>
</div>
<div style="margin-bottom: 15px;">
<label>Exam Name</label>
<input type="text" id="examName" placeholder="e.g., Paper 1">
</div>
<div style="margin-bottom: 15px;">
<label>Date</label>
<input type="date" id="examDate">
</div>
<div style="margin-bottom: 15px;">
<label>Time</label>
<input type="time" id="examTime">
</div>
<div style="display: flex; gap: 10px; margin-top: 20px;">
<button class="btn-primary" onclick="addExam()" style="flex: 1;">Add</button>
<button class="btn-secondary" onclick="closeModal('addExamModal')" style="flex: 1;">Cancel</button>
</div>
</div>
</div>

<div id="createClassCodeModal" class="modal">
<div class="modal-content">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h3>Create Class Code</h3>
<button onclick="closeModal('createClassCodeModal')" style="background: transparent; color: var(--text-secondary); padding: 8px;">✕</button>
</div>

<div style="margin-bottom: 15px;">
<label>Subject</label>
<input type="text" id="codeSubject" placeholder="e.g., Maths, English, Science">
</div>

<div style="margin-bottom: 15px;">
<label>Class/Set Name (Optional)</label>
<input type="text" id="codeClassName" placeholder="e.g., Set 1, Set 3, Top Set, Class A">
<p style="font-size: 12px; color: #999; margin-top: 5px;">
Helps you organize multiple classes for the same subject/year
</p>
</div>


<div style="margin-bottom: 15px;">
<label>Year Group</label>
<select id="codeYear">
<option value="7">Year 7</option>
<option value="8">Year 8</option>
<option value="9">Year 9</option>
<option value="10">Year 10</option>
<option value="11">Year 11</option>
<option value="12">Year 12 (AS)</option>
<option value="13">Year 13 (A2)</option>
</select>
</div>

<div style="margin-bottom: 15px;">
<label>Exam Board (Optional)</label>
<select id="codeExamBoard">
<option value="">Not specified</option>
<option value="AQA">AQA</option>
<option value="Edexcel">Edexcel</option>
<option value="OCR">OCR</option>
<option value="WJEC">WJEC</option>
<option value="CCEA">CCEA</option>
<option value="Eduqas">Eduqas</option>
<option value="Cambridge">Cambridge International</option>
<option value="Pearson">Pearson</option>
</select>
</div>


<p style="background: var(--bg-primary); padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; color: var(--text-secondary);">
<strong>ℹ️ How it works:</strong><br>
Students will enter this code during signup or from their dashboard to link to you. You'll be able to see their progress in the subject you specify.
</p>

<div style="display: flex; gap: 10px;">
<button class="btn-primary" onclick="createClassCode()" style="flex: 1;">Generate Code</button>
<button class="btn-secondary" onclick="closeModal('createClassCodeModal')" style="flex: 1;">Cancel</button>
</div>
</div>
</div>


<div id="linkTeacherModal" class="modal">
<div class="modal-content">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h3>Link to a Teacher</h3>
<button onclick="closeModal('linkTeacherModal')" style="background: transparent; color: var(--text-secondary); padding: 8px;">✕</button>
</div>

<div style="margin-bottom: 15px;">
<label>Teacher's Class Code</label>
<input type="text" id="teacherCode" placeholder="e.g., SMITH-MATH-Y11-X4K2" style="text-transform: uppercase;">
<p style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
Get this code from your teacher. It's usually written on the board or in your Google Classroom.
</p>
</div>

<div style="background: var(--bg-primary); padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;">
<strong>📚 What happens when you link?</strong>
<ul style="margin: 10px 0 0 20px; color: var(--text-secondary);">
<li style="margin-bottom: 5px;">Your teacher can see your progress in their subject</li>
<li style="margin-bottom: 5px;">They can view your flashcards and study time</li>
<li style="margin-bottom: 5px;">You can unlink at any time</li>
<li>You can link to multiple teachers for different subjects</li>
</ul>
</div>

<div style="display: flex; gap: 10px;">
<button class="btn-primary" onclick="linkToTeacher()" style="flex: 1;">Link to Teacher</button>
<button class="btn-secondary" onclick="closeModal('linkTeacherModal')" style="flex: 1;">Cancel</button>
</div>
</div>
</div>

<script>
setTimeout(function() {
if (typeof firebase === 'undefined') {
alert('Firebase failed to load. Please refresh.');
return;
}

const firebaseConfig = {
apiKey: "AIzaSyAyonlIqfTusq_ST6PKbzSED0s_HGRmA1o",
authDomain: "reviseright-pro.firebaseapp.com",
projectId: "reviseright-pro",
storageBucket: "reviseright-pro.firebasestorage.app",
messagingSenderId: "709040682753",
appId: "1:709040682753:web:645212006b33e06610cd00",
measurementId: "G-T6BNH4JP6Z"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
let selectedAccountType = 'student';

let state = {
activeTab: 'dashboard',
accountType: 'student',
studyLevel: 'gcse',
subscriptionType: 'free',
isPremium: false,
isLifetime: false,
schoolName: '',
subjects: [],
topics: [],
schedule: [],
flashcards: [],
exams: [],
currentYear: 'year10',
students: [],
pomodoro: {
sessionsToday: 0,
streak: 0,
coins: 0,
lastStudyDate: null
},
progress8: {
english: { target: '', current: '', subject: 'English Language', tier: '' },
maths: { target: '', current: '', subject: 'Maths', tier: '' },
ebacc1: { target: '', current: '', subject: 'Science', tier: '' },
ebacc2: { target: '', current: '', subject: 'History/Geography', tier: '' },
ebacc3: { target: '', current: '', subject: 'Language', tier: '' },
open1: { target: '', current: '', subject: 'Open Slot 1', tier: '' },
open2: { target: '', current: '', subject: 'Open Slot 2', tier: '' },
open3: { target: '', current: '', subject: 'Open Slot 3', tier: '' }
},
classCode: '',
classCodes: [],
linkedTeachers: [],
theme: 'default',
fontSize: '16px',
achievements: [],
unlockedAchievements: [],
achievementXP: 0,
notifications: []
};

const gradePoints = {
'9': 9, '8': 8, '7': 7, '6': 6, '5': 5,
'4': 4, '3': 3, '2': 2, '1': 1, 'U': 0
};

// Account type selection
window.selectAccountType = function(type) {
selectedAccountType = type;
document.getElementById('accountTypeSelection').classList.add('hidden');
document.getElementById('signupForm').classList.remove('hidden');
document.getElementById('accountTypeLabel').textContent = type === 'teacher' ? 'Teacher' : 'Student';

if (type === 'teacher') {
document.getElementById('teacherFields').classList.remove('hidden');
document.getElementById('studentFields').classList.add('hidden');
} else {
document.getElementById('teacherFields').classList.add('hidden');
document.getElementById('studentFields').classList.remove('hidden');
}
};

window.showAccountType = function() {
document.getElementById('accountTypeSelection').classList.remove('hidden');
document.getElementById('loginForm').classList.add('hidden');
document.getElementById('signupForm').classList.add('hidden');
};

window.handleLogin = async function() {
const email = document.getElementById('loginEmail').value.trim();
const password = document.getElementById('loginPassword').value;

if (!email || !password) {
showMessage('Please fill in all fields', 'error');
return;
}

try {
await auth.signInWithEmailAndPassword(email, password);
} catch (error) {
showMessage('Login failed: ' + error.message, 'error');
}
};

window.handleSignup = async function() {
const name = document.getElementById('signupName').value.trim();
const email = document.getElementById('signupEmail').value.trim();
const password = document.getElementById('signupPassword').value;
const schoolName = document.getElementById('schoolName').value.trim();
const studyLevel = document.getElementById('studyLevel').value;

if (!name || !email || !password) {
showMessage('Please fill in all fields', 'error');
return;
}

if (selectedAccountType === 'teacher' && !schoolName) {
showMessage('Please enter school name', 'error');
return;
}

if (password.length < 6) {
showMessage('Password must be at least 6 characters', 'error');
return;
}

try {
const userCredential = await auth.createUserWithEmailAndPassword(email, password);
await userCredential.user.updateProfile({ displayName: name });
await db.collection('users').doc(userCredential.user.uid).set({
name: name,
email: email,
accountType: selectedAccountType,
studyLevel: selectedAccountType === 'student' ? studyLevel : 'gcse',
subscriptionType: 'free',
isPremium: false,
isLifetime: false,
schoolName: schoolName || '',
subjects: [],
topics: [],
schedule: [],
flashcards: [],
exams: [],
students: [],
progress8: state.progress8,
theme: 'default',
fontSize: '16px',
createdAt: firebase.firestore.FieldValue.serverTimestamp()
});

    
    // Handle class code if provided during signup
    const signupCode = document.getElementById('signupClassCode');
    if (signupCode && signupCode.value.trim()) {
      const code = signupCode.value.trim().toUpperCase();
      try {
        const codeDoc = await db.collection('classCodes').doc(code).get();
        if (codeDoc.exists && codeDoc.data().active) {
          const codeData = codeDoc.data();
          
          // Add teacher link to new user
          await db.collection('users').doc(userCredential.user.uid).update({
            linkedTeachers: [{
              teacherId: codeData.teacherId,
              teacherName: codeData.teacherName,
              subject: codeData.subject,
              classCode: code,
              year: codeData.year,
              canViewSubjects: [codeData.subject],
              linkedAt: new Date().toISOString()
            }]
          });
          
          // Update code student count
          await db.collection('classCodes').doc(code).update({
            studentsCount: firebase.firestore.FieldValue.increment(1)
          });
          
          // Add to teacher's linked students
          const teacherDoc = await db.collection('users').doc(codeData.teacherId).get();
          if (teacherDoc.exists) {
            const linkedStudents = teacherDoc.data().linkedStudents || [];
            if (!linkedStudents.includes(userCredential.user.uid)) {
              linkedStudents.push(userCredential.user.uid);
              await db.collection('users').doc(codeData.teacherId).update({
                linkedStudents: linkedStudents
              });
            }
          }
        }
      } catch (error) {
        console.error('Error processing class code:', error);
      }
    }

    showMessage('Account created successfully!', 'success');
} catch (error) {
showMessage('Signup failed: ' + error.message, 'error');
}
};

window.logout = async function() {
if (confirm('Sign out?')) {
await auth.signOut();
}
};

window.showLogin = function() {
document.getElementById('accountTypeSelection').classList.add('hidden');
document.getElementById('loginForm').classList.remove('hidden');
document.getElementById('signupForm').classList.add('hidden');
};

function showMessage(msg, type) {
const box = document.getElementById('messageBox');
const colors = {
error: 'background: #fee; color: #c33; border: 1px solid #fcc;',
success: 'background: #efe; color: #3c3; border: 1px solid #cfc;',
info: 'background: #eef; color: #33c; border: 1px solid #ccf;'
};
box.innerHTML = `<div style="padding: 12px; border-radius: 8px; margin-bottom: 15px; ${colors[type]}">${msg}</div>`;
setTimeout(() => box.innerHTML = '', 3000);
}

window.showUpgradeModal = function() {
document.getElementById('upgradeModal').classList.add('show');
};

window.upgradePlan = function(plan, isLifetime) {
const prices = {
alevel: '£4.99/month',
university: '£7.99/month',
lifetime: '£49.99 one-time'
};

alert(`Upgrade to ${isLifetime ? 'Lifetime Access' : plan.toUpperCase()}!\n\nPrice: ${prices[plan]}\n\nIn production, this would redirect to Stripe payment.\n\nFor demo: Activating premium!`);

if (isLifetime) {
state.subscriptionType = 'lifetime';
state.isPremium = true;
state.isLifetime = true;
state.studyLevel = 'university';
} else {
state.subscriptionType = 'monthly';
state.isPremium = true;
state.studyLevel = plan;
}

saveData();
closeModal('upgradeModal');
renderApp();
};

window.updateSchoolName = async function() {
state.schoolName = document.getElementById('settingsSchoolName').value.trim();
await saveData();
renderApp();
};

window.updateStudyLevel = async function() {
const newLevel = document.getElementById('settingsStudyLevel').value;

if ((newLevel === 'alevel' || newLevel === 'university') && !state.isPremium && !state.isLifetime) {
alert('This study level requires Premium. Please upgrade!');
document.getElementById('settingsStudyLevel').value = state.studyLevel;
showUpgradeModal();
return;
}

state.studyLevel = newLevel;
await saveData();
renderApp();
};

function updateUIForAccountType() {
const isTeacher = state.accountType === 'teacher';
document.getElementById('teacherTab').classList.toggle('hidden', !isTeacher);
document.getElementById('teacherBadge').classList.toggle('hidden', !isTeacher);
document.getElementById('studentTab').classList.toggle('hidden', isTeacher);
document.getElementById('topicsTab').classList.toggle('hidden', isTeacher);
document.getElementById('scheduleTab').classList.toggle('hidden', isTeacher);
}

auth.onAuthStateChanged(async function(user) {
if (user) {
currentUser = {
uid: user.uid,
email: user.email,
name: user.displayName || 'User'
};

await loadUserData();

document.getElementById('loadingScreen').classList.add('hidden');
document.getElementById('authScreen').classList.add('hidden');
document.getElementById('app').classList.remove('hidden');

updateUIForAccountType();
document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
document.querySelector('.nav-btn').classList.add('active');

renderApp();
        checkNotifications();
} else {
currentUser = null;
document.getElementById('loadingScreen').classList.add('hidden');
document.getElementById('authScreen').classList.remove('hidden');
document.getElementById('app').classList.add('hidden');
}
});

async function loadUserData() {
try {
const doc = await db.collection('users').doc(currentUser.uid).get();
if (doc.exists) {
const data = doc.data();
state.accountType = data.accountType || 'student';
state.studyLevel = data.studyLevel || 'gcse';
state.subscriptionType = data.subscriptionType || 'free';
state.isPremium = data.isPremium || false;
state.isLifetime = data.isLifetime || false;
state.schoolName = data.schoolName || '';
state.subjects = data.subjects || [];
state.topics = data.topics || [];
state.schedule = data.schedule || [];
state.flashcards = data.flashcards || [];
        // Migrate old flashcards to have difficulty property
        if (state.flashcards) {
          state.flashcards.forEach(f => {
            if (f.difficulty === undefined) f.difficulty = 0;
          });
        }
state.exams = data.exams || [];
state.students = data.students || [];
state.progress8 = data.progress8 || state.progress8;
        // Initialize tier property for existing slots
        if (state.progress8) {
          Object.keys(state.progress8).forEach(key => {
            if (!state.progress8[key].tier) state.progress8[key].tier = '';
          });
        }
state.pomodoro = data.pomodoro || state.pomodoro;
state.theme = data.theme || 'default';
state.fontSize = data.fontSize || '16px';
        state.unlockedAchievements = data.unlockedAchievements || [];
        state.achievementXP = data.achievementXP || 0;
        state.classCodes = data.classCodes || [];
        state.linkedTeachers = data.linkedTeachers || [];

applyTheme();
applyFontSize();
}
} catch (error) {
console.error('Error loading data:', error);
}
}

async function saveData() {
if (!currentUser) return;
try {
await db.collection('users').doc(currentUser.uid).update({
accountType: state.accountType,
studyLevel: state.studyLevel,
subscriptionType: state.subscriptionType,
isPremium: state.isPremium,
isLifetime: state.isLifetime,
schoolName: state.schoolName,
subjects: state.subjects,
topics: state.topics,
schedule: state.schedule,
flashcards: state.flashcards,
exams: state.exams,
students: state.students,
progress8: state.progress8,
pomodoro: state.pomodoro,
theme: state.theme,
fontSize: state.fontSize,
        unlockedAchievements: state.unlockedAchievements || [],
        achievementXP: state.achievementXP || 0,
        classCodes: state.classCodes || [],
        linkedTeachers: state.linkedTeachers || [],
lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
});
} catch (error) {
console.error('Save error:', error);
}
}

function applyTheme() {
document.body.className = state.theme !== 'default' ? `theme-${state.theme}` : '';
if (document.getElementById('themeSelect')) {
document.getElementById('themeSelect').value = state.theme;
}
}

function applyFontSize() {
document.body.style.fontSize = state.fontSize;
if (document.getElementById('fontSelect')) {
document.getElementById('fontSelect').value = state.fontSize;
}
}

window.changeTheme = function() {
state.theme = document.getElementById('themeSelect').value;
applyTheme();
saveData();
};

window.changeFontSize = function() {
state.fontSize = document.getElementById('fontSelect').value;
applyFontSize();
saveData();
};

// FIXED switchTab function
window.switchTab = function(tab) {
state.activeTab = tab;

// Hide all tabs
document.getElementById('dashboardTab').classList.add('hidden');
document.getElementById('teacherDashboard').classList.add('hidden');
document.getElementById('progress8Tab').classList.add('hidden');
document.getElementById('subjectsTab').classList.add('hidden');
document.getElementById('topicsTab').classList.add('hidden');
document.getElementById('flashcardsTab').classList.add('hidden');
document.getElementById('pomodoroTab').classList.add('hidden');
document.getElementById('examsTab').classList.add('hidden');
document.getElementById('scheduleTab').classList.add('hidden');
document.getElementById('settingsTab').classList.add('hidden');
    document.getElementById('achievementsTab').classList.add('hidden');
document.getElementById('teacherTabContent').classList.add('hidden');

// Show the selected tab
if (tab === 'dashboard') {
if (state.accountType === 'teacher') {
document.getElementById('teacherDashboard').classList.remove('hidden');
} else {
document.getElementById('dashboardTab').classList.remove('hidden');
}
} else if (tab === 'teacher') {
document.getElementById('teacherTabContent').classList.remove('hidden');
} else {
document.getElementById(tab + 'Tab').classList.remove('hidden');
}

// Update active nav button
document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
const navBtns = document.querySelectorAll('.nav-btn');
navBtns.forEach(btn => {
const onclick = btn.getAttribute('onclick');
if (onclick && onclick.includes(`'${tab}'`)) {
btn.classList.add('active');
}
});

renderApp();
};

function calculateP8Stats() {
let totalTarget = 0, totalCurrent = 0, count = 0, currentCount = 0;

Object.values(state.progress8).forEach(slot => {
if (slot.target && gradePoints[slot.target] !== undefined) {
totalTarget += gradePoints[slot.target];
count++;
}
if (slot.current && gradePoints[slot.current] !== undefined) {
totalCurrent += gradePoints[slot.current];
currentCount++;
}
});

const avgTarget = count > 0 ? (totalTarget / count).toFixed(1) : '0.0';
const avgCurrent = currentCount > 0 ? (totalCurrent / currentCount).toFixed(1) : '0.0';
const p8Score = count > 0 ? ((totalCurrent / count) - (totalTarget / count)).toFixed(2) : '0.00';

return { p8Score, avgTarget, avgCurrent, totalPoints: totalCurrent };
}

function getPointsDiff(target, current) {
if (!target || !current) return 0;
return gradePoints[current] - gradePoints[target];
}

window.updateProgress8 = function(slot, field, value) {
state.progress8[slot][field] = value;
saveData();
renderApp();
};

window.showAddSubject = function() {
document.getElementById('addSubjectModal').classList.add('show');
};

window.addSubject = function() {
const name = document.getElementById('subjectName').value.trim();
const teacher = document.getElementById('subjectTeacher').value.trim();
const target = document.getElementById('subjectTarget').value;
  const tier = document.getElementById('subjectTier').value;

if (!name) {
alert('Please enter subject name');
return;
}

state.subjects.push({
id: Date.now(),
name,
teacher,
target,
    tier
});

saveData();
closeModal('addSubjectModal');
renderApp();

document.getElementById('subjectName').value = '';
document.getElementById('subjectTeacher').value = '';
document.getElementById('subjectTarget').value = '';
  document.getElementById('subjectTier').value = '';
};

window.deleteSubject = function(id) {
if (confirm('Delete this subject?')) {
state.subjects = state.subjects.filter(s => s.id !== id);
saveData();
renderApp();
}
};

window.showAddTopic = function() {
const select = document.getElementById('topicSubject');
select.innerHTML = '<option value="">Select subject...</option>';
state.subjects.forEach(s => {
select.innerHTML += `<option value="${s.name}">${s.name}</option>`;
});
document.getElementById('addTopicModal').classList.add('show');
};

window.addTopic = function() {
const subject = document.getElementById('topicSubject').value;
const name = document.getElementById('topicName').value.trim();
const confidence = document.getElementById('topicConfidence').value;

if (!subject || !name) {
alert('Please fill all fields');
return;
}

state.topics.push({
id: Date.now(),
subject,
name,
confidence
});

saveData();
closeModal('addTopicModal');
renderApp();
document.getElementById('topicName').value = '';
};

window.deleteTopic = function(id) {
if (confirm('Delete this topic?')) {
state.topics = state.topics.filter(t => t.id !== id);
saveData();
renderApp();
}
};

window.showAddSchedule = function() {
const select = document.getElementById('scheduleSubject');
select.innerHTML = '<option value="">Select subject...</option>';
state.subjects.forEach(s => {
select.innerHTML += `<option value="${s.name}">${s.name}</option>`;
});
document.getElementById('addScheduleModal').classList.add('show');
};

window.addSchedule = function() {
const subject = document.getElementById('scheduleSubject').value;
const date = document.getElementById('scheduleDate').value;
const time = document.getElementById('scheduleTime').value;
const duration = document.getElementById('scheduleDuration').value;

if (!subject || !date || !time) {
alert('Please fill all fields');
return;
}

state.schedule.push({
id: Date.now(),
subject,
date,
time,
duration: duration || 60
});

state.schedule.sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time));
saveData();
closeModal('addScheduleModal');
renderApp();

document.getElementById('scheduleDate').value = '';
document.getElementById('scheduleTime').value = '';
document.getElementById('scheduleDuration').value = '';
};

window.deleteSchedule = function(id) {
if (confirm('Delete this session?')) {
state.schedule = state.schedule.filter(s => s.id !== id);
saveData();
renderApp();
}
};

window.showAddStudent = function() {
document.getElementById('addStudentModal').classList.add('show');
};

window.addStudent = function() {
const name = document.getElementById('studentName').value.trim();
const year = document.getElementById('studentYear').value;
const email = document.getElementById('studentEmail').value.trim();

if (!name) {
alert('Please enter student name');
return;
}

state.students.push({
id: Date.now(),
name,
year,
email,
progress8: JSON.parse(JSON.stringify(state.progress8))
});

saveData();
closeModal('addStudentModal');
renderApp();

document.getElementById('studentName').value = '';
document.getElementById('studentEmail').value = '';
};

window.deleteStudent = function(id) {
if (confirm('Delete this student?')) {
state.students = state.students.filter(s => s.id !== id);
saveData();
renderApp();
}
};

window.viewStudentP8 = function(id) {
const student = state.students.find(s => s.id === id);
if (!student) return;

document.getElementById('studentModalName').textContent = student.name + ' - Progress 8';

const stats = calculateStudentP8(student.progress8);

let html = `
<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;">
<div class="stat-card">
<div class="stat-value" style="font-size: 28px;">${stats.p8Score}</div>
<div class="stat-label">P8 Score</div>
</div>
<div class="stat-card">
<div class="stat-value" style="font-size: 28px;">${stats.totalPoints}</div>
<div class="stat-label">Total Points</div>
</div>
</div>
`;

Object.entries(student.progress8).forEach(([key, slot]) => {
const diff = getPointsDiff(slot.target, slot.current);
const diffClass = diff > 0 ? 'points-positive' : diff < 0 ? 'points-negative' : 'points-neutral';

html += `
<div class="p8-slot">
<div class="p8-header">
<input type="text" value="${slot.subject}" onchange="updateStudentP8(${id}, '${key}', 'subject', this.value)" placeholder="Subject name" style="font-weight: 600; border: 1px solid var(--border); padding: 6px; width: 60%;">
${diff !== 0 ? `<span class="points-badge ${diffClass}">${diff > 0 ? '+' : ''}${diff} pts</span>` : ''}
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
<div>
<label style="font-size: 11px; color: var(--text-secondary);">Target</label>
<select onchange="updateStudentP8(${id}, '${key}', 'target', this.value)" style="width: 100%; margin-top: 5px; padding: 6px;">
<option value="">-</option>
${[9,8,7,6,5,4,3,2,1].map(g => `<option value="${g}" ${slot.target == g ? 'selected' : ''}>${g} (${g} pts)</option>`).join('')}
</select>
</div>
<div>
<label style="font-size: 11px; color: var(--text-secondary);">Current</label>
<select onchange="updateStudentP8(${id}, '${key}', 'current', this.value)" style="width: 100%; margin-top: 5px; padding: 6px;">
<option value="">-</option>
${[9,8,7,6,5,4,3,2,1,'U'].map(g => `<option value="${g}" ${slot.current == g ? 'selected' : ''}>${g} (${gradePoints[g]} pts)</option>`).join('')}
</select>
</div>
</div>
</div>
`;
});

document.getElementById('studentP8Content').innerHTML = html;
document.getElementById('viewStudentModal').classList.add('show');
};

window.updateStudentP8 = function(studentId, slot, field, value) {
const student = state.students.find(s => s.id === studentId);
if (student) {
student.progress8[slot][field] = value;
saveData();
viewStudentP8(studentId);
}
};

function calculateStudentP8(progress8) {
let totalTarget = 0, totalCurrent = 0, count = 0;

Object.values(progress8).forEach(slot => {
if (slot.target && gradePoints[slot.target] !== undefined) {
totalTarget += gradePoints[slot.target];
count++;
}
if (slot.current && gradePoints[slot.current] !== undefined) {
totalCurrent += gradePoints[slot.current];
}
});

const p8Score = count > 0 ? ((totalCurrent / count) - (totalTarget / count)).toFixed(2) : '0.00';
return { p8Score, totalPoints: totalCurrent };
}

window.closeModal = function(id) {
document.getElementById(id).classList.remove('show');
};

window.showForgotPassword = function() {
  document.getElementById('forgotPasswordModal').classList.add('show');
}

window.sendPasswordReset = async function() {
  const email = document.getElementById('resetEmail').value.trim();
  const messageBox = document.getElementById('resetMessage');
  
  if (!email) {
    messageBox.innerHTML = '<div style="padding: 10px; background: #fee; color: #c33; border-radius: 6px; font-size: 14px;">⚠️ Please enter your email address</div>';
    return;
  }
  
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    messageBox.innerHTML = '<div style="padding: 10px; background: #fee; color: #c33; border-radius: 6px; font-size: 14px;">⚠️ Please enter a valid email address</div>';
    return;
  }
  
  try {
    await auth.sendPasswordResetEmail(email);
    
    messageBox.innerHTML = '<div style="padding: 10px; background: #efe; color: #2d5; border-radius: 6px; font-size: 14px;">✅ Password reset email sent! Check your inbox (and spam folder).</div>';
    
    setTimeout(() => {
      document.getElementById('resetEmail').value = '';
      closeModal('forgotPasswordModal');
      messageBox.innerHTML = '';
    }, 4000);
    
  } catch (error) {
    console.error('Password reset error:', error);
    
    let errorMsg = '❌ ';
    
    if (error.code === 'auth/user-not-found') {
      errorMsg += 'No account exists with this email address.';
    } else if (error.code === 'auth/invalid-email') {
      errorMsg += 'Invalid email address format.';
    } else if (error.code === 'auth/too-many-requests') {
      errorMsg += 'Too many requests. Please try again later.';
    } else {
      errorMsg += 'Error sending reset email: ' + error.message;
    }
    
    messageBox.innerHTML = `<div style="padding: 10px; background: #fee; color: #c33; border-radius: 6px; font-size: 14px;">${errorMsg}</div>`;
  }
}

// Year/Level System
const yearConfig = {
gcse: ['year10', 'year11'],
alevel: ['as', 'a2'],
university: ['year1', 'year2', 'year3', 'year4', 'year5']
};

function renderYearTabs() {
if (state.accountType === 'teacher') {
document.getElementById('yearSelector').classList.add('hidden');
return;
}

document.getElementById('yearSelector').classList.remove('hidden');
const years = yearConfig[state.studyLevel] || [];
const labels = {
year10: 'Year 10', year11: 'Year 11',
as: 'AS (Year 12)', a2: 'A2 (Year 13)',
year1: 'Year 1', year2: 'Year 2', year3: 'Year 3', year4: 'Year 4', year5: 'Year 5'
};

let html = '';
years.forEach(year => {
const active = state.currentYear === year ? 'active' : '';
html += `<div class="year-tab ${active}" onclick="switchYear('${year}')">${labels[year]}</div>`;
});

document.getElementById('yearTabs').innerHTML = html;
}

window.switchYear = function(year) {
state.currentYear = year;
saveData();
renderApp();
};

// Flashcard Functions
window.showAddFlashcard = function() {
const select = document.getElementById('flashcardSubject');
select.innerHTML = '<option value="">Select subject...</option>';
state.subjects.forEach(s => {
select.innerHTML += `<option value="${s.name}">${s.name}</option>`;
});
document.getElementById('addFlashcardModal').classList.add('show');
};

window.addFlashcard = function() {
const subject = document.getElementById('flashcardSubject').value;
const front = document.getElementById('flashcardFront').value.trim();
const back = document.getElementById('flashcardBack').value.trim();

if (!subject || !front || !back) {
alert('Please fill all fields');
return;
}

if (!state.flashcards) state.flashcards = [];

state.flashcards.push({
id: Date.now(),
subject,
front,
back,
mastered: false,
year: state.currentYear,
    difficulty: 0});

saveData();
closeModal('addFlashcardModal');
renderApp();

document.getElementById('flashcardFront').value = '';
document.getElementById('flashcardBack').value = '';
};

window.deleteFlashcard = function(id) {
if (confirm('Delete this flashcard?')) {
state.flashcards = state.flashcards.filter(f => f.id !== id);
saveData();
renderApp();
}
};

// Flashcard Study Mode
let currentCardIndex = 0;
let studyCards = [];

window.showStudyMode = function() {
  // Include ALL cards (mastered and unmastered) but weight by difficulty
  const allCards = state.flashcards.filter(f => f.year === state.currentYear);

  if (allCards.length === 0) {
    alert('No flashcards to study! Add some first.');
    return;
  }

  // Create a weighted deck - cards with more "wrong" marks appear more often
  studyCards = [];
  allCards.forEach(card => {
    // Ensure card has difficulty property
    if (!card.difficulty) card.difficulty = 0;
    
    // Add card multiple times based on difficulty
    // difficulty 0 (new/mastered) = 1 time
    // difficulty 1-2 = 2 times  
    // difficulty 3-4 = 3 times
    // difficulty 5+ = 4 times
    let frequency = 1;
    if (card.difficulty >= 1) frequency = 2;
    if (card.difficulty >= 3) frequency = 3;
    if (card.difficulty >= 5) frequency = 4;
    
    for (let i = 0; i < frequency; i++) {
      studyCards.push(card);
    }
  });

  // Shuffle the weighted deck
  studyCards = studyCards.sort(() => Math.random() - 0.5);
  currentCardIndex = 0;

  document.getElementById('flashcardList').classList.add('hidden');
  document.getElementById('studyMode').classList.remove('hidden');
  document.getElementById('studyModeBtn').style.display = 'none';

  loadCard();
}

window.exitStudyMode = function() {
document.getElementById('studyMode').classList.add('hidden');
document.getElementById('flashcardList').classList.remove('hidden');
document.getElementById('studyModeBtn').style.display = 'block';
renderApp();
};

function loadCard() {
if (studyCards.length === 0) return;

const card = studyCards[currentCardIndex];
document.getElementById('cardFront').textContent = card.front;
document.getElementById('cardBack').textContent = card.back;
document.getElementById('currentCardNum').textContent = currentCardIndex + 1;
document.getElementById('totalCards').textContent = studyCards.length;
document.getElementById('flashcard').classList.remove('flipped');
}

window.flipCard = function() {
document.getElementById('flashcard').classList.toggle('flipped');
};

window.nextCard = function() {
currentCardIndex = (currentCardIndex + 1) % studyCards.length;
loadCard();
};

window.prevCard = function() {
currentCardIndex = (currentCardIndex - 1 + studyCards.length) % studyCards.length;
loadCard();
};

window.markMastered = function() {
  const card = studyCards[currentCardIndex];
  const originalCard = state.flashcards.find(f => f.id === card.id);
  
  if (originalCard) {
    originalCard.mastered = true;
    // Reset difficulty when mastered
    originalCard.difficulty = 0;
  }

  // Remove all instances of this card from study deck
  studyCards = studyCards.filter(c => c.id !== card.id);

  if (studyCards.length === 0) {
    alert('All cards reviewed! Great job! 🎉');
    exitStudyMode();
  } else {
    if (currentCardIndex >= studyCards.length) currentCardIndex = 0;
    loadCard();
  }

  saveData();
}

window.markWrong = function() {
  const card = studyCards[currentCardIndex];
  const originalCard = state.flashcards.find(f => f.id === card.id);
  
  if (originalCard) {
    // Increase difficulty and unmark as mastered
    originalCard.difficulty = (originalCard.difficulty || 0) + 1;
    originalCard.mastered = false;
    
    // Show feedback
    const feedback = document.getElementById('cardFeedback');
    if (feedback) {
      feedback.textContent = `Marked as difficult. This card will appear more often.`;
      feedback.style.color = 'var(--warning)';
      setTimeout(() => feedback.textContent = '', 2000);
    }
  }

  saveData();
  nextCard();
}

// Pomodoro Timer
let timerInterval = null;
let timeLeft = 25 * 60;
let isRunning = false;

window.startTimer = function() {
isRunning = true;
document.getElementById('startBtn').style.display = 'none';
document.getElementById('pauseBtn').style.display = 'inline-block';
document.getElementById('studyPet').classList.add('studying');

timerInterval = setInterval(() => {
timeLeft--;
updateTimerDisplay();
if (timeLeft <= 0) {
completeSession();
}
}, 1000);
};

window.pauseTimer = function() {
isRunning = false;
clearInterval(timerInterval);
document.getElementById('startBtn').style.display = 'inline-block';
document.getElementById('pauseBtn').style.display = 'none';
document.getElementById('studyPet').classList.remove('studying');
};

window.resetTimer = function() {
pauseTimer();
timeLeft = 25 * 60;
updateTimerDisplay();
};

function updateTimerDisplay() {
const minutes = Math.floor(timeLeft / 60);
const seconds = timeLeft % 60;
document.getElementById('timerDisplay').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function completeSession() {
pauseTimer();

if (!state.pomodoro) state.pomodoro = { sessionsToday: 0, streak: 0, coins: 0, lastStudyDate: null };

state.pomodoro.sessionsToday++;
state.pomodoro.coins += 10;

const today = new Date().toDateString();
if (state.pomodoro.lastStudyDate !== today) {
const yesterday = new Date(Date.now() - 86400000).toDateString();
if (state.pomodoro.lastStudyDate === yesterday) {
state.pomodoro.streak++;
} else {
state.pomodoro.streak = 1;
}
state.pomodoro.lastStudyDate = today;
}

upgradePet();
saveData();
renderApp();

alert('🎉 Session complete! +10 coins earned!');

timeLeft = 25 * 60;
updateTimerDisplay();
}

function upgradePet() {
const sessions = state.pomodoro ? state.pomodoro.sessionsToday : 0;
const pets = ['🌱', '🌿', '🌳', '🌸', '🌺', '🌻', '🦋', '🦄'];
const petIndex = Math.min(Math.floor(sessions / 2), pets.length - 1);
document.getElementById('studyPet').textContent = pets[petIndex];

const statuses = [
'Water me by studying!',
'Growing! Keep going!',
'Blooming beautifully!',
'So proud of you!',
'Amazing progress!',
'You\'re unstoppable!',
'Study champion!',
'Legendary focus! 🏆'
];
document.getElementById('petStatus').textContent = statuses[petIndex];
}

// Exam Functions
window.showAddExam = function() {
const select = document.getElementById('examSubject');
select.innerHTML = '<option value="">Select subject...</option>';
state.subjects.forEach(s => {
select.innerHTML += `<option value="${s.name}">${s.name}</option>`;
});
document.getElementById('addExamModal').classList.add('show');
};

window.addExam = function() {
const subject = document.getElementById('examSubject').value;
const name = document.getElementById('examName').value.trim();
const date = document.getElementById('examDate').value;
const time = document.getElementById('examTime').value;

if (!subject || !name || !date) {
alert('Please fill all required fields');
return;
}

if (!state.exams) state.exams = [];

state.exams.push({
id: Date.now(),
subject,
name,
date,
time: time || '09:00',
year: state.currentYear
});

state.exams.sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time));
saveData();
closeModal('addExamModal');
renderApp();

document.getElementById('examName').value = '';
document.getElementById('examDate').value = '';
document.getElementById('examTime').value = '';
};

window.deleteExam = function(id) {
if (confirm('Delete this exam?')) {
state.exams = state.exams.filter(e => e.id !== id);
saveData();
renderApp();
}
};

function getExamCountdown(examDate, examTime) {
const now = new Date();
const exam = new Date(examDate + ' ' + examTime);
const diff = exam - now;

if (diff < 0) return 'Past';

const days = Math.floor(diff / (1000 * 60 * 60 * 24));
const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

if (days > 0) return `${days} day${days > 1 ? 's' : ''} ${hours}h`;
return `${hours} hour${hours > 1 ? 's' : ''}`;
}

function getExamUrgency(examDate, examTime) {
const now = new Date();
const exam = new Date(examDate + ' ' + examTime);
const diff = exam - now;
const days = diff / (1000 * 60 * 60 * 24);

if (days < 0) return '';
if (days <= 3) return 'urgent';
if (days <= 7) return 'soon';
return '';
}

// PHASE 2: ACHIEVEMENTS SYSTEM
const achievementDefinitions = [
  { id: 'first_subject', icon: '📚', title: 'Getting Started', description: 'Add your first subject', xp: 10, condition: () => state.subjects.length >= 1 },
  { id: 'five_subjects', icon: '📖', title: 'Busy Schedule', description: 'Add 5 subjects', xp: 25, condition: () => state.subjects.length >= 5 },
  { id: 'first_flashcard', icon: '🎴', title: 'Memory Master', description: 'Create your first flashcard', xp: 10, condition: () => (state.flashcards || []).length >= 1 },
  { id: 'ten_flashcards', icon: '🎯', title: 'Flashcard Pro', description: 'Create 10 flashcards', xp: 30, condition: () => (state.flashcards || []).length >= 10 },
  { id: 'first_exam', icon: '📅', title: 'Exam Ready', description: 'Schedule your first exam', xp: 15, condition: () => (state.exams || []).length >= 1 },
  { id: 'pomodoro_5', icon: '⏱', title: 'Focus Warrior', description: 'Complete 5 Pomodoro sessions', xp: 20, condition: () => state.pomodoro && state.pomodoro.sessionsToday >= 5 },
  { id: 'streak_7', icon: '🔥', title: 'Week Streak', description: 'Study 7 days in a row', xp: 50, condition: () => state.pomodoro && state.pomodoro.streak >= 7 },
  { id: 'progress8_set', icon: '🎯', title: 'Target Setter', description: 'Set all Progress 8 targets', xp: 25, condition: () => {
    const slots = Object.values(state.progress8);
    return slots.filter(s => s.target).length >= 8;
  }},
  { id: 'grade_9', icon: '⭐', title: 'Top Grade', description: 'Achieve a grade 9 in any subject', xp: 100, condition: () => {
    const slots = Object.values(state.progress8);
    return slots.some(s => s.current === '9');
  }},
  { id: 'master_10_cards', icon: '🏆', title: 'Flashcard Master', description: 'Master 10 flashcards', xp: 40, condition: () => (state.flashcards || []).filter(f => f.mastered).length >= 10 },
];

function checkAchievements() {
  if (!state.unlockedAchievements) state.unlockedAchievements = [];
  
  let newUnlocks = [];
  
  achievementDefinitions.forEach(achievement => {
    // Check if already unlocked
    if (state.unlockedAchievements.includes(achievement.id)) return;
    
    // Check if condition is met
    if (achievement.condition()) {
      state.unlockedAchievements.push(achievement.id);
      state.achievementXP = (state.achievementXP || 0) + achievement.xp;
      newUnlocks.push(achievement);
    }
  });
  
  // Show notifications for new achievements
  if (newUnlocks.length > 0) {
    newUnlocks.forEach(achievement => {
      showNotification(
        `🎉 Achievement Unlocked: ${achievement.title}!`,
        `You earned ${achievement.xp} XP`,
        'success',
        5000
      );
    });
    saveData();
  }
}

function renderAchievements() {
  if (!state.unlockedAchievements) state.unlockedAchievements = [];
  
  const achievementsList = document.getElementById('achievementsList');
  if (!achievementsList) return;
  
  document.getElementById('totalAchievements').textContent = state.unlockedAchievements.length;
  document.getElementById('achievementXP').textContent = state.achievementXP || 0;
  document.getElementById('achievementStreak').textContent = (state.pomodoro && state.pomodoro.streak) || 0;
  
  achievementsList.innerHTML = achievementDefinitions.map(achievement => {
    const isUnlocked = state.unlockedAchievements.includes(achievement.id);
    const lockedClass = isUnlocked ? '' : 'locked';
    const iconDisplay = isUnlocked ? achievement.icon : '🔒';
    
    return `
      <div class="achievement-badge ${lockedClass}">
        <div class="achievement-icon">${iconDisplay}</div>
        <div class="achievement-info" style="flex: 1;">
          <h4>${achievement.title}</h4>
          <p>${achievement.description}</p>
          <p style="font-weight: 600; color: var(--accent); margin-top: 5px;">${achievement.xp} XP</p>
        </div>
        ${isUnlocked ? '<div style="font-size: 24px;">✓</div>' : ''}
      </div>
    `;
  }).join('');
}

// PHASE 2: NOTIFICATIONS SYSTEM
function showNotification(message, subtitle = '', type = 'info', duration = 4000) {
  const banner = document.getElementById('notificationsBanner');
  if (!banner) return;
  
  const notification = document.createElement('div');
  notification.className = `notification-banner ${type}`;
  notification.innerHTML = `
    <div>
      <div style="font-weight: 600; margin-bottom: 3px;">${message}</div>
      ${subtitle ? `<div style="font-size: 13px; opacity: 0.9;">${subtitle}</div>` : ''}
    </div>
    <button onclick="this.parentElement.remove()" style="background: transparent; color: white; padding: 5px 10px; font-size: 20px; opacity: 0.8;">×</button>
  `;
  
  banner.appendChild(notification);
  
  // Auto-remove after duration
  setTimeout(() => {
    if (notification.parentElement) {
      notification.style.opacity = '0';
      setTimeout(() => notification.remove(), 300);
    }
  }, duration);
}

function checkNotifications() {
  if (!state.exams) return;
  
  const now = new Date();
  const yearExams = state.exams.filter(e => e.year === state.currentYear);
  
  yearExams.forEach(exam => {
    const examDate = new Date(exam.date + ' ' + exam.time);
    const daysUntil = Math.ceil((examDate - now) / (1000 * 60 * 60 * 24));
    
    // Notify 7 days before
    if (daysUntil === 7) {
      showNotification(
        `📅 Exam in 1 week!`,
        `${exam.subject} - ${exam.name} on ${new Date(exam.date).toLocaleDateString()}`,
        'warning',
        6000
      );
    }
    
    // Notify 1 day before
    if (daysUntil === 1) {
      showNotification(
        `🚨 Exam Tomorrow!`,
        `${exam.subject} - ${exam.name} at ${exam.time}`,
        'warning',
        8000
      );
    }
    
    // Notify on exam day
    if (daysUntil === 0) {
      showNotification(
        `📝 Exam TODAY!`,
        `${exam.subject} - ${exam.name} at ${exam.time}`,
        'warning',
        10000
      );
    }
  });
  
  // Welcome notification for new users
  if (state.subjects.length === 0 && state.topics.length === 0) {
    showNotification(
      `👋 Welcome to ReviseRight Pro!`,
      `Start by adding your first subject`,
      'info',
      6000
    );
  }
}

// CLASS CODE & LINKING SYSTEM
function generateClassCode(subject, year, className = '') {
  const teacherName = currentUser.name.split(' ').pop().toUpperCase();
  const subjectCode = subject.substring(0, 4).toUpperCase();
  const classCode = className ? '-' + className.toUpperCase().replace(/\s+/g, '') : '';
  const random = Math.random().toString(36).substring(2, 6).toUpperCase();
  return `${teacherName}-${subjectCode}${classCode}-Y${year}-${random}`;
}

window.createClassCode = async function() {
  const subject = document.getElementById('codeSubject').value;
  const year = document.getElementById('codeYear').value;
  const className = document.getElementById('codeClassName').value.trim();
  const examBoard = document.getElementById('codeExamBoard').value;
  
  if (!subject || !year) {
    alert('Please select subject and year');
    return;
  }
  
  const code = generateClassCode(subject, year, className);
  
  // Check if code already exists
  const codeDoc = await db.collection('classCodes').doc(code).get();
  if (codeDoc.exists) {
    // Try again with different random
    createClassCode();
    return;
  }
  
  // Save to Firebase
  await db.collection('classCodes').doc(code).set({
    teacherId: currentUser.uid,
    teacherName: currentUser.name,
    subject: subject,
    year: year,
    className: className,
    examBoard: examBoard,
    active: true,
    studentsCount: 0,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  
  // Add to teacher's class codes
  if (!state.classCodes) state.classCodes = [];
  state.classCodes.push({
    code: code,
    subject: subject,
    year: year,
    className: className,
    examBoard: examBoard,
    active: true,
    studentsCount: 0,
    createdAt: new Date()
  });
  
  await saveData();
  closeModal('createClassCodeModal');
  renderApp();
  
  alert(`Class code created: ${code}\n\nShare this with your students!`);
}

window.showCreateClassCode = function() {
  document.getElementById('createClassCodeModal').classList.add('show');
}

window.copyClassCode = function(code) {
  navigator.clipboard.writeText(code).then(() => {
    alert('Code copied to clipboard: ' + code);
  }).catch(() => {
    prompt('Copy this code:', code);
  });
}

window.deactivateClassCode = async function(code) {
  if (!confirm('Deactivate this class code? Students will no longer be able to use it to link to you.')) {
    return;
  }
  
  // Update in Firebase
  await db.collection('classCodes').doc(code).update({
    active: false
  });
  
  // Update local state
  const codeObj = state.classCodes.find(c => c.code === code);
  if (codeObj) codeObj.active = false;
  
  await saveData();
  renderApp();
}

// STUDENT LINKING FUNCTIONS
window.showLinkTeacher = function() {
  document.getElementById('linkTeacherModal').classList.add('show');
}

window.linkToTeacher = async function() {
  const code = document.getElementById('teacherCode').value.trim().toUpperCase();
  
  if (!code) {
    alert('Please enter a class code');
    return;
  }
  
  // Check if code exists and is active
  const codeDoc = await db.collection('classCodes').doc(code).get();
  
  if (!codeDoc.exists) {
    alert('Invalid class code. Please check with your teacher.');
    return;
  }
  
  const codeData = codeDoc.data();
  
  if (!codeData.active) {
    alert('This class code is no longer active. Please get a new code from your teacher.');
    return;
  }
  
  // Check if already linked
  if (!state.linkedTeachers) state.linkedTeachers = [];
  if (state.linkedTeachers.some(t => t.teacherId === codeData.teacherId && t.subject === codeData.subject)) {
    alert('You are already linked to this teacher for this subject.');
    return;
  }
  
  // Add teacher link
  state.linkedTeachers.push({
    teacherId: codeData.teacherId,
    teacherName: codeData.teacherName,
    subject: codeData.subject,
    classCode: code,
    className: codeData.className || '',
    examBoard: codeData.examBoard || '',
    year: codeData.year,
    canViewSubjects: [codeData.subject],
    linkedAt: new Date().toISOString()
  });
  
  // Update student count for this code
  await db.collection('classCodes').doc(code).update({
    studentsCount: firebase.firestore.FieldValue.increment(1)
  });
  
  // Add student to teacher's linked students list
  const teacherDoc = await db.collection('users').doc(codeData.teacherId).get();
  if (teacherDoc.exists) {
    const teacherData = teacherDoc.data();
    const linkedStudents = teacherData.linkedStudents || [];
    
    if (!linkedStudents.includes(currentUser.uid)) {
      linkedStudents.push(currentUser.uid);
      await db.collection('users').doc(codeData.teacherId).update({
        linkedStudents: linkedStudents
      });
    }
  }
  
  await saveData();
  closeModal('linkTeacherModal');
  renderApp();
  
  showNotification(
    `✅ Linked to ${codeData.teacherName}!`,
    `${codeData.subject} - ${codeData.teacherName} can now view your progress`,
    'success',
    5000
  );
  
  document.getElementById('teacherCode').value = '';
}

window.viewStudentTiers = async function(classCode, className, subject) {
  document.getElementById('tiersClassName').textContent = `${subject}${className ? ' - ' + className : ''}`;
  
  // Get all students linked to this class code
  const codeDoc = await db.collection('classCodes').doc(classCode).get();
  if (!codeDoc.exists) {
    alert('Class code not found');
    return;
  }
  
  const codeData = codeDoc.data();
  const teacherId = codeData.teacherId;
  
  // Get teacher's linked students
  const teacherDoc = await db.collection('users').doc(teacherId).get();
  if (!teacherDoc.exists) return;
  
  const linkedStudentIds = teacherDoc.data().linkedStudents || [];
  
  // Fetch all student data
  const studentTiers = [];
  
  for (const studentId of linkedStudentIds) {
    try {
      const studentDoc = await db.collection('users').doc(studentId).get();
      if (studentDoc.exists) {
        const studentData = studentDoc.data();
        
        // Check if this student used THIS class code
        const hasThisCode = (studentData.linkedTeachers || []).some(t => t.classCode === classCode);
        if (!hasThisCode) continue;
        
        // Find tier info from Progress 8
        let tier = 'Not specified';
        if (studentData.progress8) {
          const p8Entries = Object.values(studentData.progress8);
          const subjectEntry = p8Entries.find(entry => 
            entry.subject && entry.subject.toLowerCase().includes(subject.toLowerCase())
          );
          if (subjectEntry && subjectEntry.tier) {
            tier = subjectEntry.tier;
          }
        }
        
        // Find target and current grades
        let target = '-', current = '-';
        if (studentData.progress8) {
          const p8Entries = Object.values(studentData.progress8);
          const subjectEntry = p8Entries.find(entry => 
            entry.subject && entry.subject.toLowerCase().includes(subject.toLowerCase())
          );
          if (subjectEntry) {
            target = subjectEntry.target || '-';
            current = subjectEntry.current || '-';
          }
        }
        
        studentTiers.push({
          name: studentData.name,
          tier: tier,
          target: target,
          current: current
        });
      }
    } catch (error) {
      console.error('Error fetching student:', error);
    }
  }
  
  // Sort by name
  studentTiers.sort((a, b) => a.name.localeCompare(b.name));
  
  // Render
  const tiersList = document.getElementById('studentTiersList');
  if (studentTiers.length === 0) {
    tiersList.innerHTML = '<p style="color: var(--text-secondary);">No students found for this class.</p>';
  } else {
    // Count tiers
    const higherCount = studentTiers.filter(s => s.tier === 'Higher').length;
    const foundationCount = studentTiers.filter(s => s.tier === 'Foundation').length;
    const notSpecifiedCount = studentTiers.filter(s => s.tier === 'Not specified').length;
    
    tiersList.innerHTML = `
      <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
        <div style="background: var(--bg-primary); padding: 12px 20px; border-radius: 8px; flex: 1; min-width: 120px;">
          <div style="font-size: 24px; font-weight: bold; color: var(--accent);">${higherCount}</div>
          <div style="font-size: 13px; color: var(--text-secondary);">Higher Tier</div>
        </div>
        <div style="background: var(--bg-primary); padding: 12px 20px; border-radius: 8px; flex: 1; min-width: 120px;">
          <div style="font-size: 24px; font-weight: bold; color: var(--success);">${foundationCount}</div>
          <div style="font-size: 13px; color: var(--text-secondary);">Foundation Tier</div>
        </div>
        <div style="background: var(--bg-primary); padding: 12px 20px; border-radius: 8px; flex: 1; min-width: 120px;">
          <div style="font-size: 24px; font-weight: bold; color: var(--text-secondary);">${notSpecifiedCount}</div>
          <div style="font-size: 13px; color: var(--text-secondary);">Not Specified</div>
        </div>
      </div>
      
      <div style="max-height: 400px; overflow-y: auto;">
        ${studentTiers.map(student => {
          const tierColor = student.tier === 'Higher' ? 'var(--accent)' : 
                           student.tier === 'Foundation' ? 'var(--success)' : 
                           'var(--text-secondary)';
          return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border);">
              <div>
                <strong>${student.name}</strong>
              </div>
              <div style="display: flex; gap: 15px; align-items: center;">
                <span style="font-size: 12px; color: var(--text-secondary);">Target: <strong>${student.target}</strong></span>
                <span style="font-size: 12px; color: var(--text-secondary);">Current: <strong>${student.current}</strong></span>
                <span style="background: ${tierColor}; color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: bold; min-width: 90px; text-align: center;">
                  ${student.tier}
                </span>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `;
  }
  
  document.getElementById('viewStudentTiersModal').classList.add('show');
}

window.unlinkTeacher = async function(teacherId, subject) {
  if (!confirm(`Unlink from this teacher? They will no longer see your ${subject} data.`)) {
    return;
  }
  
  // Find and remove the link
  const linkIndex = state.linkedTeachers.findIndex(t => 
    t.teacherId === teacherId && t.subject === subject
  );
  
  if (linkIndex > -1) {
    const link = state.linkedTeachers[linkIndex];
    state.linkedTeachers.splice(linkIndex, 1);
    
    // Update code student count
    await db.collection('classCodes').doc(link.classCode).update({
      studentsCount: firebase.firestore.FieldValue.increment(-1)
    });
    
    // Remove from teacher's linked students if no other links exist
    const stillLinkedToTeacher = state.linkedTeachers.some(t => t.teacherId === teacherId);
    if (!stillLinkedToTeacher) {
      const teacherDoc = await db.collection('users').doc(teacherId).get();
      if (teacherDoc.exists) {
        const teacherData = teacherDoc.data();
        const linkedStudents = (teacherData.linkedStudents || []).filter(id => id !== currentUser.uid);
        await db.collection('users').doc(teacherId).update({
          linkedStudents: linkedStudents
        });
      }
    }
    
    await saveData();
    renderApp();
    
    showNotification(
      'Unlinked from teacher',
      'Your data is no longer shared with this teacher',
      'info'
    );
  }
}

// Main render function
function renderApp() {
if (!currentUser) return;

document.getElementById('userName').textContent = currentUser.name;
document.getElementById('premiumBadge').classList.toggle('hidden', !state.isPremium || state.isLifetime);
document.getElementById('lifetimeBadge').classList.toggle('hidden', !state.isLifetime);
document.getElementById('teacherBadge').classList.toggle('hidden', state.accountType !== 'teacher');

// Account type display
const accountTypeIcon = state.accountType === 'teacher' ? '👨‍🏫' : '📚';
const accountTypeText = state.accountType === 'teacher' ? 'Teacher' : 'Student';
document.getElementById('accountTypeDisplay').innerHTML = `${accountTypeIcon} ${accountTypeText}`;

if (state.accountType === 'teacher') {
document.getElementById('schoolNameField').classList.remove('hidden');
document.getElementById('studyLevelField').classList.add('hidden');
document.getElementById('settingsSchoolName').value = state.schoolName || '';
} else {
document.getElementById('schoolNameField').classList.add('hidden');
document.getElementById('studyLevelField').classList.remove('hidden');
document.getElementById('settingsStudyLevel').value = state.studyLevel;
}

// Subscription display
const plans = {
gcse: 'GCSE Free',
alevel: 'A-Level Premium - £4.99/mo',
university: 'University Premium - £7.99/mo'
};

if (state.isLifetime) {
document.getElementById('currentPlan').innerHTML = `
<div style="padding: 15px; background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); border-radius: 8px; color: white; margin-bottom: 10px;">
<div style="font-size: 20px; font-weight: bold; margin-bottom: 5px;">♾ All Access Lifetime</div>
<div style="font-size: 14px; opacity: 0.9;">Unlimited access to all features forever</div>
</div>`;
document.getElementById('planDetails').innerHTML = `
<div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 15px;">
<h4 style="margin-bottom: 10px; font-weight: 600;">✨ Your Benefits:</h4>
<div style="font-size: 14px;">
<div style="padding: 6px 0;">✅ Full GCSE Tools</div>
<div style="padding: 6px 0;">✅ Full A-Level Tools</div>
<div style="padding: 6px 0;">✅ Full University Tools</div>
<div style="padding: 6px 0;">✅ All Future Updates</div>
<div style="padding: 6px 0;">✅ Priority Support</div>
<div style="padding: 6px 0; color: var(--success); font-weight: 600;">♾ Never Expires</div>
</div>
</div>`;
} else if (state.isPremium) {
const planName = plans[state.studyLevel];
document.getElementById('currentPlan').innerHTML = `
<div style="padding: 15px; background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%); border-radius: 8px; color: white; margin-bottom: 10px;">
<div style="font-size: 20px; font-weight: bold; margin-bottom: 5px;">⭐ ${planName}</div>
<div style="font-size: 14px; opacity: 0.9;">Monthly subscription • Cancel anytime</div>
</div>`;
document.getElementById('planDetails').innerHTML = `
<div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 15px;">
<h4 style="margin-bottom: 10px; font-weight: 600;">✨ Your Benefits:</h4>
<div style="font-size: 14px;">
<div style="padding: 6px 0;">✅ All GCSE Tools</div>
<div style="padding: 6px 0;">✅ Premium Features</div>
</div>
</div>`;
} else {
document.getElementById('currentPlan').innerHTML = `
<div style="padding: 15px; background: var(--bg-secondary); border: 2px solid var(--border); border-radius: 8px; margin-bottom: 10px;">
<div style="font-size: 20px; font-weight: bold; margin-bottom: 5px; color: var(--accent);">GCSE Free</div>
<div style="font-size: 14px; color: var(--text-secondary);">Free forever • All GCSE tools included</div>
</div>`;
document.getElementById('planDetails').innerHTML = `
<div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 15px;">
<h4 style="margin-bottom: 10px; font-weight: 600;">✨ Your Benefits:</h4>
<div style="font-size: 14px;">
<div style="padding: 6px 0;">✅ Progress 8 Tracker</div>
<div style="padding: 6px 0;">✅ Subject Management</div>
<div style="padding: 6px 0;">✅ Study Schedule</div>
<div style="padding: 6px 0;">✅ All Themes</div>
</div>
</div>`;
}

document.getElementById('upgradeButton').style.display = state.isLifetime ? 'none' : 'block';
document.getElementById('upgradePrompt').classList.toggle('hidden', state.isLifetime);

// Dashboard stats
document.getElementById('subjectCount').textContent = state.subjects.length;
document.getElementById('topicCount').textContent = state.topics.length;
document.getElementById('flashcardCount').textContent = (state.flashcards || []).filter(f => f.year === state.currentYear).length;
document.getElementById('examCount').textContent = (state.exams || []).filter(e => e.year === state.currentYear && new Date(e.date) >= new Date()).length;

// Recent subjects
const recentSubjects = document.getElementById('recentSubjects');
if (state.subjects.length === 0) {
recentSubjects.innerHTML = '<p style="color: var(--text-secondary);">No subjects yet. Add one to get started!</p>';
} else {
recentSubjects.innerHTML = state.subjects.slice(0, 3).map(s => `
<div style="padding: 12px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 10px;">
<strong>${s.name}</strong>
${s.teacher ? `<div style="font-size: 14px; color: var(--text-secondary); margin-top: 5px;">${s.teacher}</div>` : ''}
${s.target ? `<span class="grade-badge grade-${s.target}" style="margin-top: 5px;">Target: ${s.target}</span>` : ''}
${s.tier ? `<div style="font-size: 13px; color: var(--text-secondary); margin-top: 5px;">📝 Tier: ${s.tier}</div>` : ''}
</div>
`).join('');
}

// Teacher dashboard
if (state.accountType === 'teacher') {
document.getElementById('teacherName').textContent = currentUser.name;
document.getElementById('teacherSchoolName').textContent = state.schoolName ? '🏫 ' + state.schoolName : '';

const year10 = state.students.filter(s => s.year === '10').length;
const year11 = state.students.filter(s => s.year === '11').length;

document.getElementById('teacherStudentCount').textContent = state.students.length;
document.getElementById('teacherYear10Count').textContent = year10;
document.getElementById('teacherYear11Count').textContent = year11;

let totalP8 = 0;
state.students.forEach(s => {
const stats = calculateStudentP8(s.progress8);
totalP8 += parseFloat(stats.p8Score);
});
document.getElementById('teacherAvgP8').textContent = state.students.length > 0 ? (totalP8 / state.students.length).toFixed(2) : '0.00';

// Recent students
const recentStudents = document.getElementById('recentStudents');
if (state.students.length === 0) {
recentStudents.innerHTML = '<p style="color: var(--text-secondary);">No students yet.</p>';
} else {
recentStudents.innerHTML = state.students.slice(0, 3).map(s => {
const stats = calculateStudentP8(s.progress8);
return `
<div style="padding: 12px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
<div>
<div style="font-weight: 600;">${s.name}</div>
<div style="font-size: 13px; color: var(--text-secondary);">Year ${s.year} • P8: ${stats.p8Score}</div>
</div>
<button class="btn-primary" onclick="viewStudentP8(${s.id})" style="padding: 6px 12px; font-size: 12px;">View</button>
</div>
`;
}).join('');
}
}

// Year tabs
renderYearTabs();

// Hide Progress 8 for A-Level and University
if (state.studyLevel === 'alevel' || state.studyLevel === 'university') {
document.getElementById('progress8Nav').classList.add('hidden');
} else {
document.getElementById('progress8Nav').classList.remove('hidden');
}

// Progress 8 stats
const stats = calculateP8Stats();
document.getElementById('p8Score').textContent = stats.p8Score;
document.getElementById('avgTarget').textContent = stats.avgTarget;
document.getElementById('avgCurrent').textContent = stats.avgCurrent;
document.getElementById('totalPoints').textContent = stats.totalPoints;

// Progress 8 list
const p8List = document.getElementById('progress8List');
p8List.innerHTML = Object.entries(state.progress8).map(([key, slot]) => {
const diff = getPointsDiff(slot.target, slot.current);
const diffClass = diff > 0 ? 'points-positive' : diff < 0 ? 'points-negative' : 'points-neutral';
return `
<div class="p8-slot">
<div class="p8-header">
<input type="text" value="${slot.subject}" onchange="updateProgress8('${key}', 'subject', this.value)" placeholder="Subject name" style="font-weight: 600; border: 1px solid var(--border); padding: 8px; width: 70%;">
${diff !== 0 ? `<span class="points-badge ${diffClass}">${diff > 0 ? '+' : ''}${diff} pts</span>` : ''}
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
<div>
<label style="font-size: 12px; color: var(--text-secondary);">Target Grade</label>
<select onchange="updateProgress8('${key}', 'target', this.value)" style="width: 100%; margin-top: 5px;">
<option value="">-</option>
${[9,8,7,6,5,4,3,2,1].map(g => `<option value="${g}" ${slot.target == g ? 'selected' : ''}>${g} (${g} pts)</option>`).join('')}
</select>
</div>
<div>
<label style="font-size: 12px; color: var(--text-secondary);">Current Grade</label>
<select onchange="updateProgress8('${key}', 'current', this.value)" style="width: 100%; margin-top: 5px;">
<option value="">-</option>
${[9,8,7,6,5,4,3,2,1,'U'].map(g => `<option value="${g}" ${slot.current == g ? 'selected' : ''}>${g} (${gradePoints[g]} pts)</option>`).join('')}
</select>
</div>
</div>
<div style="margin-top: 10px;">
<label style="font-size: 12px; color: var(--text-secondary);">Exam Tier</label>
<select onchange="updateProgress8('${key}', 'tier', this.value)" style="width: 100%; margin-top: 5px; padding: 6px;">
<option value="">Not specified</option>
<option value="Higher" ${slot.tier === 'Higher' ? 'selected' : ''}>Higher (4-9)</option>
<option value="Foundation" ${slot.tier === 'Foundation' ? 'selected' : ''}>Foundation (1-5)</option>
</select>
</div>
</div>
`;
}).join('');

// Students list (teacher)
if (state.accountType === 'teacher') {
const studentsList = document.getElementById('studentsList');
if (state.students.length === 0) {
studentsList.innerHTML = '<p style="color: var(--text-secondary);">No students added. Click "Add Student" to begin.</p>';
} else {
studentsList.innerHTML = state.students.map(s => {
const studentStats = calculateStudentP8(s.progress8);
return `
<div class="student-row">
<div>
<div style="font-weight: 600; margin-bottom: 4px;">${s.name}</div>
<div style="font-size: 13px; color: var(--text-secondary);">Year ${s.year} • P8: ${studentStats.p8Score} • Points: ${studentStats.totalPoints}</div>
</div>
<div style="display: flex; gap: 8px;">
<button class="btn-primary" onclick="viewStudentP8(${s.id})" style="padding: 8px 12px; font-size: 13px;">View P8</button>
<button class="btn-danger" onclick="deleteStudent(${s.id})" style="padding: 8px 12px; font-size: 13px;">Delete</button>
</div>
</div>
`;
}).join('');
}
}

// Subjects list
const subjectsList = document.getElementById('subjectsList');
if (state.subjects.length === 0) {
subjectsList.innerHTML = '<p style="color: var(--text-secondary);">No subjects yet. Click "Add Subject" to get started!</p>';
} else {
subjectsList.innerHTML = state.subjects.map(s => `
<div style="padding: 15px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
<div>
<div style="font-weight: 600; margin-bottom: 5px;">${s.name}</div>
${s.teacher ? `<div style="font-size: 14px; color: var(--text-secondary);">Teacher: ${s.teacher}</div>` : ''}
${s.tier ? `<div style="font-size: 13px; color: var(--text-secondary); margin-top: 5px;">📝 Tier: ${s.tier}</div>` : ''}
${s.target ? `<span class="grade-badge grade-${s.target}" style="margin-top: 8px;">Target: ${s.target}</span>` : ''}
</div>
<button class="btn-danger" onclick="deleteSubject(${s.id})" style="padding: 8px 12px; font-size: 14px;">Delete</button>
</div>
`).join('');
}

// Topics list
const topicsList = document.getElementById('topicsList');
if (state.topics.length === 0) {
topicsList.innerHTML = '<p style="color: var(--text-secondary);">No topics yet. Click "Add Topic" to start tracking!</p>';
} else {
const grouped = {};
state.topics.forEach(t => {
if (!grouped[t.subject]) grouped[t.subject] = [];
grouped[t.subject].push(t);
});
topicsList.innerHTML = Object.entries(grouped).map(([subject, topics]) => `
<div style="margin-bottom: 20px;">
<h4 style="margin-bottom: 10px; color: var(--accent);">${subject}</h4>
${topics.map(t => `
<div style="padding: 12px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
<div>
<div style="font-weight: 500;">${t.name}</div>
<div style="font-size: 14px; margin-top: 5px;">
${t.confidence === 'high' ? '😊 High' : t.confidence === 'medium' ? '😐 Medium' : '😟 Low'} confidence
</div>
</div>
<button class="btn-danger" onclick="deleteTopic(${t.id})" style="padding: 6px 10px; font-size: 12px;">Delete</button>
</div>
`).join('')}
</div>
`).join('');
}

// Schedule list
const scheduleList = document.getElementById('scheduleList');
if (state.schedule.length === 0) {
scheduleList.innerHTML = '<p style="color: var(--text-secondary);">No scheduled sessions. Click "Add Session" to plan your study time!</p>';
} else {
scheduleList.innerHTML = state.schedule.map(s => `
<div style="padding: 15px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
<div>
<div style="font-weight: 600; margin-bottom: 5px;">${s.subject}</div>
<div style="font-size: 14px; color: var(--text-secondary);">📅 ${new Date(s.date).toLocaleDateString()} at ${s.time}</div>
<div style="font-size: 14px; color: var(--text-secondary); margin-top: 3px;">⏱ ${s.duration} minutes</div>
</div>
<button class="btn-danger" onclick="deleteSchedule(${s.id})" style="padding: 8px 12px; font-size: 14px;">Delete</button>
</div>
`).join('');
}

// Flashcards
const flashcardList = document.getElementById('flashcardList');
const yearFlashcards = (state.flashcards || []).filter(f => f.year === state.currentYear);
if (yearFlashcards.length === 0) {
flashcardList.innerHTML = '<p style="color: var(--text-secondary);">No flashcards yet. Click "Add Flashcard" to start!</p>';
document.getElementById('studyModeBtn').style.display = 'none';
} else {
document.getElementById('studyModeBtn').style.display = 'block';
const grouped = {};
yearFlashcards.forEach(f => {
if (!grouped[f.subject]) grouped[f.subject] = [];
grouped[f.subject].push(f);
});
flashcardList.innerHTML = Object.entries(grouped).map(([subject, cards]) => `
<div style="margin-bottom: 20px;">
<h4 style="margin-bottom: 10px; color: var(--accent);">${subject}</h4>
${cards.map(f => `
<div style="padding: 12px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
<div>
<div style="font-weight: 500;">${f.front}</div>
<div style="font-size: 12px; margin-top: 5px;">
${f.mastered ? '<span style="color: var(--success);">✓ Mastered</span>' : ''}
${(f.difficulty || 0) > 0 ? `<span style="color: var(--warning); margin-left: 10px;">⚠ Difficulty: ${f.difficulty}</span>` : ''}
</div>
</div>
<button class="btn-danger" onclick="deleteFlashcard(${f.id})" style="padding: 6px 10px; font-size: 12px;">Delete</button>
</div>
`).join('')}
</div>
`).join('');
}

// Pomodoro stats
if (state.pomodoro) {
document.getElementById('sessionsToday').textContent = state.pomodoro.sessionsToday || 0;
document.getElementById('studyStreak').textContent = state.pomodoro.streak || 0;
document.getElementById('totalCoins').textContent = state.pomodoro.coins || 0;
upgradePet();
}

// Check achievements and notifications
checkAchievements();
renderAchievements();
  
// RENDER CLASS CODES (Teachers)
if (state.accountType === 'teacher') {
const classCodesList = document.getElementById('classCodesList');
if (classCodesList && state.classCodes) {
if (state.classCodes.length === 0) {
classCodesList.innerHTML = '<p style="color: var(--text-secondary);">No class codes yet. Click "Create New Code" to get started!</p>';
} else {
classCodesList.innerHTML = state.classCodes.map(code => `
<div style="background: var(--bg-primary); border: 2px solid var(--accent); border-radius: 12px; padding: 20px; margin-bottom: 15px;">
<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
<div>
<h4 style="margin: 0 0 8px 0; font-size: 18px;">${code.subject}${code.className ? " - " + code.className : ""} - Year ${code.year}</h4>
${code.examBoard ? `<div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">📋 ${code.examBoard}</div>` : ''}
<div style="display: flex; align-items: center; gap: 10px;">
<code style="background: var(--accent); color: white; padding: 8px 16px; border-radius: 6px; font-size: 16px; font-weight: bold; letter-spacing: 1px;">${code.code}</code>
<span style="color: var(--text-secondary); font-size: 14px;">👥 ${code.studentsCount || 0} students</span>
</div>
</div>
<div>
${code.active ? '<span style="background: var(--success); color: white; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: bold;">ACTIVE</span>' : '<span style="background: var(--text-secondary); color: white; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: bold;">INACTIVE</span>'}
</div>
</div>
<div style="display: flex; gap: 10px;">
<button class="btn-primary" onclick="copyClassCode('${code.code}')" style="flex: 1; padding: 10px; font-size: 13px;">📋 Copy Code</button>
<button class="btn-secondary" onclick="viewStudentTiers('${code.code}', '${code.className || ''}', '${code.subject}')" style="flex: 1; padding: 10px; font-size: 13px;">📊 View Tiers</button>
${code.active ? `<button class="btn-secondary" onclick="deactivateClassCode('${code.code}')" style="flex: 1; padding: 10px; font-size: 13px;">🔒 Deactivate</button>` : ''}
</div>
<p style="margin-top: 15px; font-size: 13px; color: var(--text-secondary);">
💡 <strong>Share this code</strong> with your ${code.subject} students. They'll enter it during signup or from their dashboard to link to you.
</p>
</div>
`).join('');
}
}
}
  
// RENDER LINKED TEACHERS (Students)
if (state.accountType === 'student') {
const linkedTeachersList = document.getElementById('linkedTeachersList');
if (linkedTeachersList && state.linkedTeachers) {
if (state.linkedTeachers.length === 0) {
linkedTeachersList.innerHTML = `
<div style="text-align: center; padding: 40px 20px; background: var(--bg-primary); border-radius: 12px;">
<div style="font-size: 48px; margin-bottom: 15px;">👨‍🏫</div>
<h4 style="margin-bottom: 10px; color: var(--text-primary);">No Teachers Linked Yet</h4>
<p style="color: var(--text-secondary); margin-bottom: 20px;">Get a class code from your teacher to link your account and let them track your progress!</p>
<button class="btn-primary" onclick="showLinkTeacher()">+ Link Your First Teacher</button>
</div>
`;
} else {
linkedTeachersList.innerHTML = state.linkedTeachers.map(teacher => `
<div style="background: var(--bg-primary); border-left: 4px solid var(--accent); border-radius: 8px; padding: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
<div>
<h4 style="margin: 0 0 5px 0; font-size: 16px;">${teacher.teacherName}</h4>
<p style="margin: 0; font-size: 14px; color: var(--text-secondary);">
📚 ${teacher.subject}${teacher.className ? " (" + teacher.className + ")" : ""} • Year ${teacher.year}
</p>
${teacher.examBoard ? `<p style="margin: 5px 0 0 0; font-size: 12px; color: var(--text-secondary);">📋 Exam Board: ${teacher.examBoard}</p>` : ''}
<p style="margin: 5px 0 0 0; font-size: 12px; color: var(--text-secondary);">
Can view: ${teacher.canViewSubjects.join(', ')}
</p>
</div>
<button class="btn-danger" onclick="unlinkTeacher('${teacher.teacherId}', '${teacher.subject}')" style="padding: 8px 12px; font-size: 13px;">Unlink</button>
</div>
`).join('');
}
}
}
  
// Exams
const examsList = document.getElementById('examsList');
const yearExams = (state.exams || []).filter(e => e.year === state.currentYear);
if (yearExams.length === 0) {
examsList.innerHTML = '<p style="color: var(--text-secondary);">No exams scheduled. Click "Add Exam" to track your countdown!</p>';
} else {
examsList.innerHTML = yearExams.map(e => {
const countdown = getExamCountdown(e.date, e.time);
const urgency = getExamUrgency(e.date, e.time);
return `
<div class="exam-card ${urgency}">
<div style="display: flex; justify-content: space-between; align-items: center;">
<div>
<div style="font-weight: 600; margin-bottom: 5px;">${e.subject} - ${e.name}</div>
<div style="font-size: 14px; color: var(--text-secondary);">📅 ${new Date(e.date).toLocaleDateString()} at ${e.time}</div>
<div class="countdown" style="margin-top: 8px;">${countdown === 'Past' ? '⏰ Exam has passed' : '⏰ ' + countdown}</div>
</div>
<button class="btn-danger" onclick="deleteExam(${e.id})" style="padding: 8px 12px; font-size: 14px;">Delete</button>
</div>
</div>
`;
}).join('');
}
}

}, 1000);
</script>
</body>
</html>
