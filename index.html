<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4f46e5">
    <title>ReviseRight Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --bg-primary: #f7f9fb;
            --bg-secondary: #ffffff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --accent: #4f46e5;
            --accent-light: #818cf8;
            --border: #e5e7eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --premium: #f59e0b;
            --lifetime: #8b5cf6;
        }
        
        body.theme-dark {
            --bg-primary: #1f2937;
            --bg-secondary: #111827;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --accent: #818cf8;
            --accent-light: #a78bfa;
            --border: #374151;
        }
        
        body.theme-dyslexia {
            --bg-primary: #fef3c7;
            --bg-secondary: #fffbeb;
            --text-primary: #000000;
            --text-secondary: #1f2937;
            --accent: #059669;
            --accent-light: #10b981;
            --border: #fbbf24;
            font-family: 'Comic Sans MS', Arial, sans-serif !important;
            letter-spacing: 0.05em;
            line-height: 1.8;
        }
        
        body.theme-blue {
            --bg-primary: #dbeafe;
            --bg-secondary: #eff6ff;
            --text-primary: #1e3a8a;
            --text-secondary: #1e40af;
            --accent: #2563eb;
            --accent-light: #3b82f6;
            --border: #93c5fd;
        }
        
        body.theme-pink {
            --bg-primary: #fce7f3;
            --bg-secondary: #fef3f9;
            --text-primary: #831843;
            --text-secondary: #9f1239;
            --accent: #db2777;
            --accent-light: #ec4899;
            --border: #f9a8d4;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        .hidden { display: none !important; }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        button:active { transform: scale(0.98); }
        
        .btn-primary {
            background: var(--accent);
            color: white;
        }
        
        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-premium {
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            color: white;
        }
        
        .btn-lifetime {
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
            margin-top: 8px;
        }
        
        .nav {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 15px 20px;
            display: flex;
            gap: 10px;
            overflow-x: auto;
        }
        
        .nav-btn {
            padding: 10px 20px;
            background: transparent;
            color: var(--text-secondary);
            border: none;
            border-radius: 8px;
            white-space: nowrap;
            font-weight: 500;
        }
        
        .nav-btn.active {
            background: var(--accent);
            color: white;
        }
        
        .grade-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 13px;
            margin: 3px;
        }
        
        .grade-9 { background: #10b981; color: white; }
        .grade-8 { background: #3b82f6; color: white; }
        .grade-7 { background: #8b5cf6; color: white; }
        .grade-6 { background: #f59e0b; color: white; }
        .grade-5 { background: #ef4444; color: white; }
        .grade-4 { background: #dc2626; color: white; }
        .grade-3 { background: #991b1b; color: white; }
        .grade-2 { background: #7f1d1d; color: white; }
        .grade-1 { background: #6b7280; color: white; }
        .grade-U { background: #374151; color: white; }
        
        .stat-card {
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }
        
        .p8-slot {
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
        }
        
        .p8-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        
        .points-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .points-positive { background: #10b981; color: white; }
        .points-neutral { background: #6b7280; color: white; }
        .points-negative { background: #ef4444; color: white; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }
        
        .modal.show { display: flex; }
        
        .modal-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 25px;
            max-width: 1000px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px;
        }
        
        .teacher-badge {
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .premium-badge {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .lifetime-badge {
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .student-row {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .pricing-card {
            background: var(--bg-secondary);
            border: 3px solid var(--border);
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            position: relative;
            transition: transform 0.2s;
        }
        
        .pricing-card:hover {
            transform: translateY(-5px);
        }
        
        .pricing-card.featured {
            border-color: var(--accent);
            box-shadow: 0 10px 40px rgba(79, 70, 229, 0.2);
        }
        
        .pricing-card.best-value {
            border-color: var(--lifetime);
            box-shadow: 0 10px 40px rgba(139, 92, 246, 0.3);
            transform: scale(1.05);
        }
        
        .pricing-badge {
            position: absolute;
            top: -12px;
            right: 20px;
            background: var(--accent);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .best-value-badge {
            position: absolute;
            top: -12px;
            right: 20px;
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .savings-label {
            background: #10b981;
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            display: inline-block;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .stat-card { padding: 15px; }
            .stat-value { font-size: 28px; }
            .pricing-card.best-value { transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div style="text-align: center; color: white;">
            <div style="font-size: 60px; margin-bottom: 20px;">üìö</div>
            <h2 style="font-size: 32px; margin-bottom: 10px;">ReviseRight Pro</h2>
            <p>Loading...</p>
        </div>
    </div>

    <!-- Auth Screen -->
    <div id="authScreen" class="hidden" style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px;">
        <div style="background: white; border-radius: 20px; padding: 40px; max-width: 400px; width: 100%;">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="font-size: 50px; margin-bottom: 15px;">üìö</div>
                <h1 style="font-size: 32px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ReviseRight Pro</h1>
                <p style="color: #666; margin-top: 10px;">Your complete study companion</p>
            </div>

            <div id="messageBox"></div>

            <!-- Account Type Selection -->
            <div id="accountTypeSelection">
                <h3 style="margin-bottom: 20px; text-align: center; color: #333;">Choose Account Type</h3>
                <button onclick="selectAccountType('student')" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px; border-radius: 10px; font-weight: bold; margin-bottom: 10px;">
                    üë®‚Äçüéì Student Account
                </button>
                <button onclick="selectAccountType('teacher')" style="width: 100%; background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%); color: white; padding: 16px; border-radius: 10px; font-weight: bold;">
                    üë®‚Äçüè´ Teacher Account
                </button>
                <p style="text-align: center; margin-top: 15px; color: #666; font-size: 14px;">
                    Have an account? <a onclick="showLogin()" style="color: #667eea; font-weight: bold; cursor: pointer;">Sign In</a>
                </p>
            </div>

            <!-- Login Form -->
            <div id="loginForm" class="hidden">
                <h2 style="margin-bottom: 20px; color: #333;">Sign In</h2>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: #666; margin-bottom: 5px;">Email</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com" style="border: 1px solid #ddd;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: #666; margin-bottom: 5px;">Password</label>
                    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="border: 1px solid #ddd;">
                </div>
                <button onclick="handleLogin()" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 14px; border-radius: 10px; font-weight: bold; margin-top: 10px;">Sign In</button>
                <p style="text-align: center; margin-top: 15px; color: #666; font-size: 14px;">
                    <a onclick="showAccountType()" style="color: #667eea; font-weight: bold; cursor: pointer;">‚Üê Back</a>
                </p>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" class="hidden">
                <h2 style="margin-bottom: 20px; color: #333;">Create <span id="accountTypeLabel">Student</span> Account</h2>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: #666; margin-bottom: 5px;">Name</label>
                    <input type="text" id="signupName" placeholder="Your name" style="border: 1px solid #ddd;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: #666; margin-bottom: 5px;">Email</label>
                    <input type="email" id="signupEmail" placeholder="your@email.com" style="border: 1px solid #ddd;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: #666; margin-bottom: 5px;">Password</label>
                    <input type="password" id="signupPassword" placeholder="At least 6 characters" style="border: 1px solid #ddd;">
                </div>
                <div id="teacherFields" class="hidden" style="margin-bottom: 15px;">
                    <label style="display: block; color: #666; margin-bottom: 5px;">School Name</label>
                    <input type="text" id="schoolName" placeholder="Your school" style="border: 1px solid #ddd;">
                </div>
                <div id="studentFields" class="hidden" style="margin-bottom: 15px;">
                    <label style="display: block; color: #666; margin-bottom: 5px;">Current Study Level</label>
                    <select id="studyLevel" style="border: 1px solid #ddd;">
                        <option value="gcse">GCSE (Free)</option>
                        <option value="alevel">A-Level (Premium)</option>
                        <option value="university">University (Premium)</option>
                    </select>
                </div>
                <button onclick="handleSignup()" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 14px; border-radius: 10px; font-weight: bold; margin-top: 10px;">Create Account</button>
                <p style="text-align: center; margin-top: 15px; color: #666; font-size: 14px;">
                    <a onclick="showAccountType()" style="color: #667eea; font-weight: bold; cursor: pointer;">‚Üê Back</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden">
        <!-- Navigation -->
        <div class="nav">
            <button class="nav-btn active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="nav-btn" onclick="switchTab('progress8')">üéØ Progress 8</button>
            <button class="nav-btn" id="teacherNavBtn" onclick="switchTab('teacher')" class="hidden">üë®‚Äçüè´ Students</button>
            <button class="nav-btn" id="subjectsNavBtn" onclick="switchTab('subjects')">üìö Subjects</button>
            <button class="nav-btn" id="topicsNavBtn" onclick="switchTab('topics')">üìù Topics</button>
            <button class="nav-btn" id="scheduleNavBtn" onclick="switchTab('schedule')">üìÖ Schedule</button>
            <button class="nav-btn" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
        </div>

        <div class="container">
            <!-- Student Dashboard -->
            <div id="dashboardTab">
                <div class="card">
                    <h2 style="margin-bottom: 10px;">Welcome back, <span id="userName"></span>! 
                        <span id="teacherBadge" class="hidden teacher-badge">TEACHER</span>
                        <span id="premiumBadge" class="hidden premium-badge">‚≠ê PREMIUM</span>
                        <span id="lifetimeBadge" class="hidden lifetime-badge">‚ôæÔ∏è LIFETIME</span>
                    </h2>
                    <p style="color: var(--text-secondary);">Here's your study overview</p>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-value" id="subjectCount">0</div>
                        <div class="stat-label">Subjects</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="topicCount">0</div>
                        <div class="stat-label">Topics</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="scheduleCount">0</div>
                        <div class="stat-label">Schedule Items</div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 15px;">üìö Recent Subjects</h3>
                    <div id="recentSubjects"></div>
                </div>

                <!-- Upgrade prompt -->
                <div id="upgradePrompt" class="hidden card" style="background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); color: white; text-align: center;">
                    <h3 style="margin-bottom: 10px;">üåü Unlock Lifetime Access</h3>
                    <p style="margin-bottom: 20px; opacity: 0.9;">Get unlimited access to GCSE, A-Level & University tools for life!</p>
                    <button onclick="switchTab('settings')" style="background: white; color: #8b5cf6; padding: 12px 30px; border-radius: 8px; font-weight: bold;">View Plans</button>
                </div>
            </div>

            <!-- Teacher Dashboard -->
            <div id="teacherDashboard" class="hidden">
                <div class="card">
                    <h2 style="margin-bottom: 10px;">üë®‚Äçüè´ Teacher Overview - <span id="teacherName"></span></h2>
                    <p style="color: var(--text-secondary);"><span id="teacherSchoolName"></span></p>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="stat-card" style="border-color: var(--accent);">
                        <div class="stat-value" id="teacherStudentCount">0</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="teacherYear10Count">0</div>
                        <div class="stat-label">Year 10</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="teacherYear11Count">0</div>
                        <div class="stat-label">Year 11</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="teacherAvgP8">0.00</div>
                        <div class="stat-label">Average P8</div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 15px;">üìä Class Performance</h3>
                    <div id="classPerformance"></div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>üë• Recent Students</h3>
                        <button class="btn-primary" onclick="switchTab('teacher')">View All</button>
                    </div>
                    <div id="recentStudents"></div>
                </div>
            </div>

            <!-- Progress 8 Tab -->
            <div id="progress8Tab" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2 style="margin-bottom: 5px;">üéØ Progress 8 Tracker</h2>
                            <p style="color: var(--text-secondary); font-size: 14px;">Track your GCSE grades with the official Progress 8 points system</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div class="stat-card" style="border: 3px solid var(--accent);">
                            <div class="stat-value" id="p8Score">0.00</div>
                            <div class="stat-label">Progress 8 Score</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avgTarget">0.0</div>
                            <div class="stat-label">Avg Target Grade</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avgCurrent">0.0</div>
                            <div class="stat-label">Avg Current Grade</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalPoints">0</div>
                            <div class="stat-label">Total Points</div>
                        </div>
                    </div>

                    <div style="background: var(--bg-primary); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px; font-size: 14px; color: var(--text-secondary);">üìä Grade Points Reference:</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <span class="grade-badge grade-9">9 = 9pts</span>
                            <span class="grade-badge grade-8">8 = 8pts</span>
                            <span class="grade-badge grade-7">7 = 7pts</span>
                            <span class="grade-badge grade-6">6 = 6pts</span>
                            <span class="grade-badge grade-5">5 = 5pts</span>
                            <span class="grade-badge grade-4">4 = 4pts</span>
                            <span class="grade-badge grade-3">3 = 3pts</span>
                            <span class="grade-badge grade-2">2 = 2pts</span>
                            <span class="grade-badge grade-1">1 = 1pt</span>
                            <span class="grade-badge grade-U">U = 0pts</span>
                        </div>
                    </div>
                    
                    <div id="progress8List"></div>
                </div>
            </div>

            <!-- Teacher Students Tab -->
            <div id="teacherTabContent" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2>üë®‚Äçüè´ Student Management</h2>
                            <p style="color: var(--text-secondary); font-size: 14px;">Manage Year 10 & 11 students</p>
                        </div>
                        <button class="btn-primary" onclick="showAddStudent()">+ Add Student</button>
                    </div>
                    <div id="studentsList"></div>
                </div>
            </div>

            <!-- Subjects Tab -->
            <div id="subjectsTab" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <h2>üìö My Subjects</h2>
                        <button class="btn-primary" onclick="showAddSubject()">+ Add Subject</button>
                    </div>
                    <div id="subjectsList"></div>
                </div>
            </div>

            <!-- Topics Tab -->
            <div id="topicsTab" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <h2>üìù Study Topics</h2>
                        <button class="btn-primary" onclick="showAddTopic()">+ Add Topic</button>
                    </div>
                    <div id="topicsList"></div>
                </div>
            </div>

            <!-- Schedule Tab -->
            <div id="scheduleTab" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <h2>üìÖ Study Schedule</h2>
                        <button class="btn-primary" onclick="showAddSchedule()">+ Add Session</button>
                    </div>
                    <div id="scheduleList"></div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="hidden">
                <div class="card">
                    <h2 style="margin-bottom: 20px;">‚öôÔ∏è Settings</h2>
                    
                    <!-- Subscription Section -->
                    <div id="subscriptionSection" style="background: var(--bg-primary); border-radius: 10px; padding: 20px; margin-bottom: 25px;">
                        <h3 style="margin-bottom: 15px;">üíé Subscription</h3>
                        <div id="currentPlan" style="margin-bottom: 15px;"></div>
                        <button id="upgradeButton" onclick="showUpgradeModal()" class="btn-premium" style="display: none;">‚≠ê View Plans</button>
                    </div>
                    
                    <div style="background: var(--bg-primary); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">Account Type</label>
                        <select id="accountTypeSelect" onchange="changeAccountType()" style="width: 100%;">
                            <option value="student">üë®‚Äçüéì Student</option>
                            <option value="teacher">üë®‚Äçüè´ Teacher</option>
                        </select>
                        <div id="schoolNameField" class="hidden" style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">School Name</label>
                            <input type="text" id="settingsSchoolName" placeholder="Your school" onchange="updateSchoolName()">
                        </div>
                        <div id="studyLevelField" class="hidden" style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Study Level</label>
                            <select id="settingsStudyLevel" onchange="updateStudyLevel()">
                                <option value="gcse">GCSE</option>
                                <option value="alevel">A-Level</option>
                                <option value="university">University</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">Theme</label>
                        <select id="themeSelect" onchange="changeTheme()" style="width: 100%;">
                            <option value="default">Default (Light)</option>
                            <option value="dark">Dark Mode</option>
                            <option value="blue">Blue Theme</option>
                            <option value="pink">Pink Theme</option>
                            <option value="dyslexia">Dyslexia Friendly</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">Font Size</label>
                        <select id="fontSelect" onchange="changeFontSize()" style="width: 100%;">
                            <option value="14px">Small</option>
                            <option value="16px" selected>Medium</option>
                            <option value="18px">Large</option>
                            <option value="20px">Extra Large</option>
                        </select>
                    </div>

                    <button class="btn-secondary" onclick="logout()" style="width: 100%; margin-top: 20px;">Sign Out</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upgrade/Pricing Modal -->
    <div id="upgradeModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2>‚≠ê Choose Your Plan</h2>
                <button onclick="closeModal('upgradeModal')" style="background: transparent; color: var(--text-secondary); padding: 8px;">‚úï</button>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;">
                <!-- GCSE Free -->
                <div class="pricing-card">
                    <h3 style="margin-bottom: 10px;">GCSE</h3>
                    <div style="font-size: 36px; font-weight: bold; margin: 20px 0;">FREE</div>
                    <div style="text-align: left; margin: 20px 0;">
                        <div style="padding: 8px 0;">‚úÖ Progress 8 Tracker</div>
                        <div style="padding: 8px 0;">‚úÖ Subject Management</div>
                        <div style="padding: 8px 0;">‚úÖ Study Schedule</div>
                        <div style="padding: 8px 0;">‚úÖ All Themes</div>
                    </div>
                    <button class="btn-secondary" disabled style="width: 100%; opacity: 0.6;">Current Plan</button>
                </div>

                <!-- A-Level Monthly -->
                <div class="pricing-card featured">
                    <div class="pricing-badge">POPULAR</div>
                    <h3 style="margin-bottom: 10px;">A-Level</h3>
                    <div style="font-size: 36px; font-weight: bold; margin: 20px 0;">¬£4.99<span style="font-size: 16px;">/mo</span></div>
                    <div style="text-align: left; margin: 20px 0;">
                        <div style="padding: 8px 0;">‚úÖ Everything in GCSE</div>
                        <div style="padding: 8px 0;">‚≠ê A-Level Subjects</div>
                        <div style="padding: 8px 0;">‚≠ê Advanced Analytics</div>
                        <div style="padding: 8px 0;">‚≠ê Exam Predictions</div>
                    </div>
                    <button class="btn-premium" onclick="upgradePlan('alevel', false)" style="width: 100%;">Upgrade to A-Level</button>
                </div>

                <!-- University Monthly -->
                <div class="pricing-card featured">
                    <h3 style="margin-bottom: 10px;">University</h3>
                    <div style="font-size: 36px; font-weight: bold; margin: 20px 0;">¬£7.99<span style="font-size: 16px;">/mo</span></div>
                    <div style="text-align: left; margin: 20px 0;">
                        <div style="padding: 8px 0;">‚úÖ Everything in A-Level</div>
                        <div style="padding: 8px 0;">‚≠ê University Modules</div>
                        <div style="padding: 8px 0;">‚≠ê Research Tools</div>
                        <div style="padding: 8px 0;">‚≠ê Citation Manager</div>
                    </div>
                    <button class="btn-premium" onclick="upgradePlan('university', false)" style="width: 100%;">Upgrade to University</button>
                </div>

                <!-- ALL ACCESS LIFETIME -->
                <div class="pricing-card best-value">
                    <div class="best-value-badge">‚≠ê BEST VALUE</div>
                    <h3 style="margin-bottom: 10px; color: var(--lifetime);">‚ôæÔ∏è All Access Lifetime</h3>
                    <div style="font-size: 36px; font-weight: bold; margin: 20px 0; background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                        ¬£49.99<span style="font-size: 16px;">once</span>
                    </div>
                    <div class="savings-label">üí∞ Save ¬£145+ per year!</div>
                    <div style="text-align: left; margin: 20px 0;">
                        <div style="padding: 8px 0; font-weight: 600;">‚úÖ EVERYTHING INCLUDED:</div>
                        <div style="padding: 8px 0;">üéì GCSE Tools</div>
                        <div style="padding: 8px 0;">üéì A-Level Tools</div>
                        <div style="padding: 8px 0;">üéì University Tools</div>
                        <div style="padding: 8px 0;">‚ôæÔ∏è Lifetime Access</div>
                        <div style="padding: 8px 0;">‚ö° All Future Updates</div>
                        <div style="padding: 8px 0;">üåü Priority Support</div>
                    </div>
                    <button class="btn-lifetime" onclick="upgradePlan('lifetime', true)" style="width: 100%;">üöÄ Get Lifetime Access</button>
                    <p style="font-size: 12px; color: var(--text-secondary); margin-top: 10px;">‚úÖ One-time payment ‚Ä¢ Use throughout your entire studies</p>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px; padding: 20px; background: var(--bg-primary); border-radius: 10px;">
                <p style="font-size: 14px; color: var(--text-secondary);">üí≥ Secure payment ‚Ä¢ Monthly plans cancel anytime ‚Ä¢ 7-day money-back guarantee</p>
            </div>
        </div>
    </div>

    <!-- Other Modals (addSubject, addTopic, etc. - keeping them short for space) -->
    <div id="addSubjectModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px;">Add Subject</h3>
            <div style="margin-bottom: 15px;">
                <label>Subject Name</label>
                <input type="text" id="subjectName" placeholder="e.g., Mathematics">
            </div>
            <div style="margin-bottom: 15px;">
                <label>Teacher</label>
                <input type="text" id="subjectTeacher" placeholder="e.g., Mr. Smith">
            </div>
            <div style="margin-bottom: 15px;">
                <label>Target Grade</label>
                <select id="subjectTarget">
                    <option value="">Select grade...</option>
                    <option value="9">9</option><option value="8">8</option><option value="7">7</option><option value="6">6</option><option value="5">5</option><option value="4">4</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-primary" onclick="addSubject()" style="flex: 1;">Add</button>
                <button class="btn-secondary" onclick="closeModal('addSubjectModal')" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <div id="addTopicModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px;">Add Topic</h3>
            <div style="margin-bottom: 15px;">
                <label>Subject</label>
                <select id="topicSubject"></select>
            </div>
            <div style="margin-bottom: 15px;">
                <label>Topic Name</label>
                <input type="text" id="topicName" placeholder="e.g., Quadratic Equations">
            </div>
            <div style="margin-bottom: 15px;">
                <label>Confidence</label>
                <select id="topicConfidence">
                    <option value="low">üòü Low</option>
                    <option value="medium">üòê Medium</option>
                    <option value="high">üòä High</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-primary" onclick="addTopic()" style="flex: 1;">Add</button>
                <button class="btn-secondary" onclick="closeModal('addTopicModal')" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <div id="addScheduleModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px;">Add Study Session</h3>
            <div style="margin-bottom: 15px;">
                <label>Subject</label>
                <select id="scheduleSubject"></select>
            </div>
            <div style="margin-bottom: 15px;">
                <label>Date</label>
                <input type="date" id="scheduleDate">
            </div>
            <div style="margin-bottom: 15px;">
                <label>Time</label>
                <input type="time" id="scheduleTime">
            </div>
            <div style="margin-bottom: 15px;">
                <label>Duration (minutes)</label>
                <input type="number" id="scheduleDuration" placeholder="60">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-primary" onclick="addSchedule()" style="flex: 1;">Add</button>
                <button class="btn-secondary" onclick="closeModal('addScheduleModal')" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px;">Add Student</h3>
            <div style="margin-bottom: 15px;">
                <label>Student Name</label>
                <input type="text" id="studentName" placeholder="Full name">
            </div>
            <div style="margin-bottom: 15px;">
                <label>Year Group</label>
                <select id="studentYear">
                    <option value="10">Year 10</option>
                    <option value="11">Year 11</option>
                </select>
            </div>
            <div style="margin-bottom: 15px;">
                <label>Student Email (optional)</label>
                <input type="email" id="studentEmail" placeholder="student@school.com">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-primary" onclick="addStudent()" style="flex: 1;">Add</button>
                <button class="btn-secondary" onclick="closeModal('addStudentModal')" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <div id="viewStudentModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 id="studentModalName">Student Progress 8</h3>
                <button onclick="closeModal('viewStudentModal')" style="background: transparent; color: var(--text-secondary); padding: 8px;">‚úï</button>
            </div>
            <div id="studentP8Content"></div>
        </div>
    </div>

    <script>
        setTimeout(function() {
            if (typeof firebase === 'undefined') {
                alert('Firebase failed to load. Please refresh.');
                return;
            }

            const firebaseConfig = {
                apiKey: "AIzaSyAyonlIqfTusq_ST6PKbzSED0s_HGRmA1o",
                authDomain: "reviseright-pro.firebaseapp.com",
                projectId: "reviseright-pro",
                storageBucket: "reviseright-pro.firebasestorage.app",
                messagingSenderId: "709040682753",
                appId: "1:709040682753:web:645212006b33e06610cd00",
                measurementId: "G-T6BNH4JP6Z"
            };

            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            let currentUser = null;
            let selectedAccountType = 'student';
            let state = {
                activeTab: 'dashboard',
                accountType: 'student',
                studyLevel: 'gcse',
                subscriptionType: 'free', // 'free', 'monthly', 'lifetime'
                isPremium: false,
                isLifetime: false,
                schoolName: '',
                subjects: [],
                topics: [],
                schedule: [],
                students: [],
                progress8: {
                    english: { target: '', current: '', subject: 'English Language' },
                    maths: { target: '', current: '', subject: 'Maths' },
                    ebacc1: { target: '', current: '', subject: 'Science' },
                    ebacc2: { target: '', current: '', subject: 'History/Geography' },
                    ebacc3: { target: '', current: '', subject: 'Language' },
                    open1: { target: '', current: '', subject: 'Open Slot 1' },
                    open2: { target: '', current: '', subject: 'Open Slot 2' },
                    open3: { target: '', current: '', subject: 'Open Slot 3' }
                },
                theme: 'default',
                fontSize: '16px'
            };

            const gradePoints = {
                '9': 9, '8': 8, '7': 7, '6': 6, '5': 5,
                '4': 4, '3': 3, '2': 2, '1': 1, 'U': 0
            };

            // Account type selection
            window.selectAccountType = function(type) {
                selectedAccountType = type;
                document.getElementById('accountTypeSelection').classList.add('hidden');
                document.getElementById('signupForm').classList.remove('hidden');
                document.getElementById('accountTypeLabel').textContent = type === 'teacher' ? 'Teacher' : 'Student';
                
                if (type === 'teacher') {
                    document.getElementById('teacherFields').classList.remove('hidden');
                    document.getElementById('studentFields').classList.add('hidden');
                } else {
                    document.getElementById('teacherFields').classList.add('hidden');
                    document.getElementById('studentFields').classList.remove('hidden');
                }
            };

            window.showAccountType = function() {
                document.getElementById('accountTypeSelection').classList.remove('hidden');
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('signupForm').classList.add('hidden');
            };

            window.handleLogin = async function() {
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                
                if (!email || !password) {
                    showMessage('Please fill in all fields', 'error');
                    return;
                }

                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    showMessage('Login failed: ' + error.message, 'error');
                }
            };

            window.handleSignup = async function() {
                const name = document.getElementById('signupName').value.trim();
                const email = document.getElementById('signupEmail').value.trim();
                const password = document.getElementById('signupPassword').value;
                const schoolName = document.getElementById('schoolName').value.trim();
                const studyLevel = document.getElementById('studyLevel').value;
                
                if (!name || !email || !password) {
                    showMessage('Please fill in all fields', 'error');
                    return;
                }

                if (selectedAccountType === 'teacher' && !schoolName) {
                    showMessage('Please enter school name', 'error');
                    return;
                }

                if (password.length < 6) {
                    showMessage('Password must be at least 6 characters', 'error');
                    return;
                }

                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await userCredential.user.updateProfile({ displayName: name });
                    
                    await db.collection('users').doc(userCredential.user.uid).set({
                        name: name,
                        email: email,
                        accountType: selectedAccountType,
                        studyLevel: selectedAccountType === 'student' ? studyLevel : 'gcse',
                        subscriptionType: 'free',
                        isPremium: false,
                        isLifetime: false,
                        schoolName: schoolName || '',
                        subjects: [],
                        topics: [],
                        schedule: [],
                        students: [],
                        progress8: state.progress8,
                        theme: 'default',
                        fontSize: '16px',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showMessage('Account created successfully!', 'success');
                } catch (error) {
                    showMessage('Signup failed: ' + error.message, 'error');
                }
            };

            window.logout = async function() {
                if (confirm('Sign out?')) {
                    await auth.signOut();
                }
            };

            window.showLogin = function() {
                document.getElementById('accountTypeSelection').classList.add('hidden');
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('signupForm').classList.add('hidden');
            };

            function showMessage(msg, type) {
                const box = document.getElementById('messageBox');
                const colors = {
                    error: 'background: #fee; color: #c33; border: 1px solid #fcc;',
                    success: 'background: #efe; color: #3c3; border: 1px solid #cfc;',
                    info: 'background: #eef; color: #33c; border: 1px solid #ccf;'
                };
                box.innerHTML = `<div style="padding: 12px; border-radius: 8px; margin-bottom: 15px; ${colors[type]}">${msg}</div>`;
                setTimeout(() => box.innerHTML = '', 3000);
            }

            window.showUpgradeModal = function() {
                document.getElementById('upgradeModal').classList.add('show');
            };

            window.upgradePlan = function(plan, isLifetime) {
                const prices = {
                    alevel: '¬£4.99/month',
                    university: '¬£7.99/month',
                    lifetime: '¬£49.99 one-time'
                };
                
                alert(`Upgrade to ${isLifetime ? 'Lifetime Access' : plan.toUpperCase()}!\n\nPrice: ${prices[plan]}\n\nIn production, this would redirect to Stripe payment.\n\nFor demo: Activating premium!`);
                
                if (isLifetime) {
                    state.subscriptionType = 'lifetime';
                    state.isPremium = true;
                    state.isLifetime = true;
                    state.studyLevel = 'university'; // Full access
                } else {
                    state.subscriptionType = 'monthly';
                    state.isPremium = true;
                    state.studyLevel = plan;
                }
                
                saveData();
                closeModal('upgradeModal');
                renderApp();
            };

            window.changeAccountType = async function() {
                const newType = document.getElementById('accountTypeSelect').value;
                state.accountType = newType;
                
                if (newType === 'teacher') {
                    document.getElementById('schoolNameField').classList.remove('hidden');
                    document.getElementById('studyLevelField').classList.add('hidden');
                } else {
                    document.getElementById('schoolNameField').classList.add('hidden');
                    document.getElementById('studyLevelField').classList.remove('hidden');
                }
                
                await saveData();
                updateUIForAccountType();
                renderApp();
            };

            window.updateSchoolName = async function() {
                state.schoolName = document.getElementById('settingsSchoolName').value.trim();
                await saveData();
                renderApp();
            };

            window.updateStudyLevel = async function() {
                const newLevel = document.getElementById('settingsStudyLevel').value;
                if ((newLevel === 'alevel' || newLevel === 'university') && !state.isPremium) {
                    alert('This study level requires Premium. Please upgrade!');
                    document.getElementById('settingsStudyLevel').value = state.studyLevel;
                    showUpgradeModal();
                    return;
                }
                state.studyLevel = newLevel;
                await saveData();
                renderApp();
            };

            function updateUIForAccountType() {
                const isTeacher = state.accountType === 'teacher';
                
                document.getElementById('teacherNavBtn').classList.toggle('hidden', !isTeacher);
                document.getElementById('teacherBadge').classList.toggle('hidden', !isTeacher);
                
                document.getElementById('subjectsNavBtn').classList.toggle('hidden', isTeacher);
                document.getElementById('topicsNavBtn').classList.toggle('hidden', isTeacher);
                document.getElementById('scheduleNavBtn').classList.toggle('hidden', isTeacher);
                
                if (isTeacher) {
                    document.getElementById('dashboardTab').classList.add('hidden');
                    document.getElementById('teacherDashboard').classList.remove('hidden');
                } else {
                    document.getElementById('dashboardTab').classList.remove('hidden');
                    document.getElementById('teacherDashboard').classList.add('hidden');
                }
            }

            auth.onAuthStateChanged(async function(user) {
                if (user) {
                    currentUser = {
                        uid: user.uid,
                        email: user.email,
                        name: user.displayName || 'User'
                    };
                    
                    await loadUserData();
                    
                    document.getElementById('loadingScreen').classList.add('hidden');
                    document.getElementById('authScreen').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    
                    updateUIForAccountType();
                    renderApp();
                } else {
                    currentUser = null;
                    document.getElementById('loadingScreen').classList.add('hidden');
                    document.getElementById('authScreen').classList.remove('hidden');
                    document.getElementById('app').classList.add('hidden');
                }
            });

            async function loadUserData() {
                try {
                    const doc = await db.collection('users').doc(currentUser.uid).get();
                    if (doc.exists) {
                        const data = doc.data();
                        state.accountType = data.accountType || 'student';
                        state.studyLevel = data.studyLevel || 'gcse';
                        state.subscriptionType = data.subscriptionType || 'free';
                        state.isPremium = data.isPremium || false;
                        state.isLifetime = data.isLifetime || false;
                        state.schoolName = data.schoolName || '';
                        state.subjects = data.subjects || [];
                        state.topics = data.topics || [];
                        state.schedule = data.schedule || [];
                        state.students = data.students || [];
                        state.progress8 = data.progress8 || state.progress8;
                        state.theme = data.theme || 'default';
                        state.fontSize = data.fontSize || '16px';
                        
                        applyTheme();
                        applyFontSize();
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            }

            async function saveData() {
                if (!currentUser) return;
                try {
                    await db.collection('users').doc(currentUser.uid).update({
                        accountType: state.accountType,
                        studyLevel: state.studyLevel,
                        subscriptionType: state.subscriptionType,
                        isPremium: state.isPremium,
                        isLifetime: state.isLifetime,
                        schoolName: state.schoolName,
                        subjects: state.subjects,
                        topics: state.topics,
                        schedule: state.schedule,
                        students: state.students,
                        progress8: state.progress8,
                        theme: state.theme,
                        fontSize: state.fontSize,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Save error:', error);
                }
            }

            function applyTheme() {
                document.body.className = state.theme !== 'default' ? `theme-${state.theme}` : '';
                if (document.getElementById('themeSelect')) {
                    document.getElementById('themeSelect').value = state.theme;
                }
            }

            function applyFontSize() {
                document.body.style.fontSize = state.fontSize;
                if (document.getElementById('fontSelect')) {
                    document.getElementById('fontSelect').value = state.fontSize;
                }
            }

            window.changeTheme = function() {
                state.theme = document.getElementById('themeSelect').value;
                applyTheme();
                saveData();
            };

            window.changeFontSize = function() {
                state.fontSize = document.getElementById('fontSelect').value;
                applyFontSize();
                saveData();
            };

            window.switchTab = function(tab) {
                state.activeTab = tab;
                
                const tabs = ['dashboardTab', 'teacherDashboard', 'progress8Tab', 'subjectsTab', 'topicsTab', 'scheduleTab', 'settingsTab', 'teacherTabContent'];
                tabs.forEach(t => {
                    const el = document.getElementById(t);
                    if (el) el.classList.add('hidden');
                });
                
                if (tab === 'dashboard') {
                    if (state.accountType === 'teacher') {
                        document.getElementById('teacherDashboard').classList.remove('hidden');
                    } else {
                        document.getElementById('dashboardTab').classList.remove('hidden');
                    }
                } else if (tab === 'teacher') {
                    document.getElementById('teacherTabContent').classList.remove('hidden');
                } else {
                    document.getElementById(tab + 'Tab').classList.remove('hidden');
                }
                
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                
                renderApp();
            };

            function calculateP8Stats() {
                let totalTarget = 0, totalCurrent = 0, count = 0, currentCount = 0;
                
                Object.values(state.progress8).forEach(slot => {
                    if (slot.target && gradePoints[slot.target] !== undefined) {
                        totalTarget += gradePoints[slot.target];
                        count++;
                    }
                    if (slot.current && gradePoints[slot.current] !== undefined) {
                        totalCurrent += gradePoints[slot.current];
                        currentCount++;
                    }
                });
                
                const avgTarget = count > 0 ? (totalTarget / count).toFixed(1) : '0.0';
                const avgCurrent = currentCount > 0 ? (totalCurrent / currentCount).toFixed(1) : '0.0';
                const p8Score = count > 0 ? ((totalCurrent / count) - (totalTarget / count)).toFixed(2) : '0.00';
                
                return { p8Score, avgTarget, avgCurrent, totalPoints: totalCurrent };
            }

            function getPointsDiff(target, current) {
                if (!target || !current) return 0;
                return gradePoints[current] - gradePoints[target];
            }

            window.updateProgress8 = function(slot, field, value) {
                state.progress8[slot][field] = value;
                saveData();
                renderApp();
            };

            window.showAddSubject = function() {
                document.getElementById('addSubjectModal').classList.add('show');
            };

            window.addSubject = function() {
                const name = document.getElementById('subjectName').value.trim();
                const teacher = document.getElementById('subjectTeacher').value.trim();
                const target = document.getElementById('subjectTarget').value;
                
                if (!name) {
                    alert('Please enter subject name');
                    return;
                }
                
                state.subjects.push({
                    id: Date.now(),
                    name,
                    teacher,
                    target
                });
                
                saveData();
                closeModal('addSubjectModal');
                renderApp();
                
                document.getElementById('subjectName').value = '';
                document.getElementById('subjectTeacher').value = '';
                document.getElementById('subjectTarget').value = '';
            };

            window.deleteSubject = function(id) {
                if (confirm('Delete this subject?')) {
                    state.subjects = state.subjects.filter(s => s.id !== id);
                    saveData();
                    renderApp();
                }
            };

            window.showAddTopic = function() {
                const select = document.getElementById('topicSubject');
                select.innerHTML = '<option value="">Select subject...</option>';
                state.subjects.forEach(s => {
                    select.innerHTML += `<option value="${s.name}">${s.name}</option>`;
                });
                document.getElementById('addTopicModal').classList.add('show');
            };

            window.addTopic = function() {
                const subject = document.getElementById('topicSubject').value;
                const name = document.getElementById('topicName').value.trim();
                const confidence = document.getElementById('topicConfidence').value;
                
                if (!subject || !name) {
                    alert('Please fill all fields');
                    return;
                }
                
                state.topics.push({
                    id: Date.now(),
                    subject,
                    name,
                    confidence
                });
                
                saveData();
                closeModal('addTopicModal');
                renderApp();
                
                document.getElementById('topicName').value = '';
            };

            window.deleteTopic = function(id) {
                if (confirm('Delete this topic?')) {
                    state.topics = state.topics.filter(t => t.id !== id);
                    saveData();
                    renderApp();
                }
            };

            window.showAddSchedule = function() {
                const select = document.getElementById('scheduleSubject');
                select.innerHTML = '<option value="">Select subject...</option>';
                state.subjects.forEach(s => {
                    select.innerHTML += `<option value="${s.name}">${s.name}</option>`;
                });
                document.getElementById('addScheduleModal').classList.add('show');
            };

            window.addSchedule = function() {
                const subject = document.getElementById('scheduleSubject').value;
                const date = document.getElementById('scheduleDate').value;
                const time = document.getElementById('scheduleTime').value;
                const duration = document.getElementById('scheduleDuration').value;
                
                if (!subject || !date || !time) {
                    alert('Please fill all fields');
                    return;
                }
                
                state.schedule.push({
                    id: Date.now(),
                    subject,
                    date,
                    time,
                    duration: duration || 60
                });
                
                state.schedule.sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time));
                
                saveData();
                closeModal('addScheduleModal');
                renderApp();
                
                document.getElementById('scheduleDate').value = '';
                document.getElementById('scheduleTime').value = '';
                document.getElementById('scheduleDuration').value = '';
            };

            window.deleteSchedule = function(id) {
                if (confirm('Delete this session?')) {
                    state.schedule = state.schedule.filter(s => s.id !== id);
                    saveData();
                    renderApp();
                }
            };

            window.showAddStudent = function() {
                document.getElementById('addStudentModal').classList.add('show');
            };

            window.addStudent = function() {
                const name = document.getElementById('studentName').value.trim();
                const year = document.getElementById('studentYear').value;
                const email = document.getElementById('studentEmail').value.trim();
                
                if (!name) {
                    alert('Please enter student name');
                    return;
                }
                
                state.students.push({
                    id: Date.now(),
                    name,
                    year,
                    email,
                    progress8: JSON.parse(JSON.stringify(state.progress8))
                });
                
                saveData();
                closeModal('addStudentModal');
                renderApp();
                
                document.getElementById('studentName').value = '';
                document.getElementById('studentEmail').value = '';
            };

            window.deleteStudent = function(id) {
                if (confirm('Delete this student?')) {
                    state.students = state.students.filter(s => s.id !== id);
                    saveData();
                    renderApp();
                }
            };

            window.viewStudentP8 = function(id) {
                const student = state.students.find(s => s.id === id);
                if (!student) return;
                
                document.getElementById('studentModalName').textContent = student.name + ' - Progress 8';
                
                const stats = calculateStudentP8(student.progress8);
                
                let html = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-value" style="font-size: 28px;">${stats.p8Score}</div>
                            <div class="stat-label">P8 Score</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" style="font-size: 28px;">${stats.totalPoints}</div>
                            <div class="stat-label">Total Points</div>
                        </div>
                    </div>
                `;
                
                Object.entries(student.progress8).forEach(([key, slot]) => {
                    const diff = getPointsDiff(slot.target, slot.current);
                    const diffClass = diff > 0 ? 'points-positive' : diff < 0 ? 'points-negative' : 'points-neutral';
                    
                    html += `
                        <div class="p8-slot">
                            <div class="p8-header">
                                <input type="text" value="${slot.subject}" onchange="updateStudentP8(${id}, '${key}', 'subject', this.value)" style="font-weight: 600; border: 1px solid var(--border); padding: 6px; width: 60%;">
                                ${diff !== 0 ? `<span class="points-badge ${diffClass}">${diff > 0 ? '+' : ''}${diff} pts</span>` : ''}
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label style="font-size: 11px; color: var(--text-secondary);">Target</label>
                                    <select onchange="updateStudentP8(${id}, '${key}', 'target', this.value)" style="width: 100%; margin-top: 5px; padding: 6px;">
                                        <option value="">-</option>
                                        ${[9,8,7,6,5,4,3,2,1].map(g => `<option value="${g}" ${slot.target == g ? 'selected' : ''}>${g}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 11px; color: var(--text-secondary);">Current</label>
                                    <select onchange="updateStudentP8(${id}, '${key}', 'current', this.value)" style="width: 100%; margin-top: 5px; padding: 6px;">
                                        <option value="">-</option>
                                        ${[9,8,7,6,5,4,3,2,1,'U'].map(g => `<option value="${g}" ${slot.current == g ? 'selected' : ''}>${g}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('studentP8Content').innerHTML = html;
                document.getElementById('viewStudentModal').classList.add('show');
            };

            window.updateStudentP8 = function(studentId, slot, field, value) {
                const student = state.students.find(s => s.id === studentId);
                if (student) {
                    student.progress8[slot][field] = value;
                    saveData();
                    viewStudentP8(studentId);
                }
            };

            function calculateStudentP8(progress8) {
                let totalTarget = 0, totalCurrent = 0, count = 0;
                
                Object.values(progress8).forEach(slot => {
                    if (slot.target && gradePoints[slot.target] !== undefined) {
                        totalTarget += gradePoints[slot.target];
                        count++;
                    }
                    if (slot.current && gradePoints[slot.current] !== undefined) {
                        totalCurrent += gradePoints[slot.current];
                    }
                });
                
                const p8Score = count > 0 ? ((totalCurrent / count) - (totalTarget / count)).toFixed(2) : '0.00';
                
                return { p8Score, totalPoints: totalCurrent };
            }

            window.closeModal = function(id) {
                document.getElementById(id).classList.remove('show');
            };

            function renderApp() {
                if (!currentUser) return;
                
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('premiumBadge').classList.toggle('hidden', !state.isPremium || state.isLifetime);
                document.getElementById('lifetimeBadge').classList.toggle('hidden', !state.isLifetime);
                
                document.getElementById('accountTypeSelect').value = state.accountType;
                
                if (state.accountType === 'teacher') {
                    document.getElementById('schoolNameField').classList.remove('hidden');
                    document.getElementById('studyLevelField').classList.add('hidden');
                    document.getElementById('settingsSchoolName').value = state.schoolName || '';
                } else {
                    document.getElementById('schoolNameField').classList.add('hidden');
                    document.getElementById('studyLevelField').classList.remove('hidden');
                    document.getElementById('settingsStudyLevel').value = state.studyLevel;
                }
                
                const plans = {
                    gcse: 'GCSE Free',
                    alevel: 'A-Level Premium - ¬£4.99/mo',
                    university: 'University Premium - ¬£7.99/mo'
                };
                
                if (state.isLifetime) {
                    document.getElementById('currentPlan').innerHTML = `
                        <p style="font-weight: 600;">Current Plan: <span style="color: var(--lifetime);">‚ôæÔ∏è All Access Lifetime</span></p>
                        <p style="color: var(--success); font-size: 14px; margin-top: 5px;">‚úì Lifetime Access Active</p>
                    `;
                } else {
                    document.getElementById('currentPlan').innerHTML = `
                        <p style="font-weight: 600;">Current Plan: <span style="color: var(--accent);">${plans[state.studyLevel]}</span></p>
                        ${state.isPremium ? '<p style="color: var(--success); font-size: 14px; margin-top: 5px;">‚úì Premium Active</p>' : ''}
                    `;
                }
                
                document.getElementById('upgradeButton').style.display = state.isLifetime ? 'none' : 'block';
                document.getElementById('upgradePrompt').classList.toggle('hidden', state.isLifetime || state.studyLevel === 'gcse');
                
                document.getElementById('subjectCount').textContent = state.subjects.length;
                document.getElementById('topicCount').textContent = state.topics.length;
                document.getElementById('scheduleCount').textContent = state.schedule.length;
                
                const recentSubjects = document.getElementById('recentSubjects');
                if (state.subjects.length === 0) {
                    recentSubjects.innerHTML = '<p style="color: var(--text-secondary);">No subjects yet. Add one to get started!</p>';
                } else {
                    recentSubjects.innerHTML = state.subjects.slice(0, 3).map(s => `
                        <div style="padding: 12px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 10px;">
                            <strong>${s.name}</strong>
                            ${s.teacher ? `<div style="font-size: 14px; color: var(--text-secondary); margin-top: 5px;">${s.teacher}</div>` : ''}
                            ${s.target ? `<span class="grade-badge grade-${s.target}" style="margin-top: 5px;">Target: ${s.target}</span>` : ''}
                        </div>
                    `).join('');
                }
                
                if (state.accountType === 'teacher') {
                    document.getElementById('teacherName').textContent = currentUser.name;
                    document.getElementById('teacherSchoolName').textContent = state.schoolName ? 'üè´ ' + state.schoolName : '';
                    
                    const year10 = state.students.filter(s => s.year === '10').length;
                    const year11 = state.students.filter(s => s.year === '11').length;
                    
                    document.getElementById('teacherStudentCount').textContent = state.students.length;
                    document.getElementById('teacherYear10Count').textContent = year10;
                    document.getElementById('teacherYear11Count').textContent = year11;
                    
                    let totalP8 = 0;
                    state.students.forEach(s => {
                        const stats = calculateStudentP8(s.progress8);
                        totalP8 += parseFloat(stats.p8Score);
                    });
                    document.getElementById('teacherAvgP8').textContent = state.students.length > 0 ? (totalP8 / state.students.length).toFixed(2) : '0.00';
                    
                    const classPerf = document.getElementById('classPerformance');
                    if (state.students.length === 0) {
                        classPerf.innerHTML = '<p style="color: var(--text-secondary);">No students added yet.</p>';
                    } else {
                        const above = state.students.filter(s => parseFloat(calculateStudentP8(s.progress8).p8Score) > 0).length;
                        const onTrack = state.students.filter(s => {
                            const p8 = parseFloat(calculateStudentP8(s.progress8).p8Score);
                            return p8 >= -0.5 && p8 <= 0.5;
                        }).length;
                        const below = state.students.filter(s => parseFloat(calculateStudentP8(s.progress8).p8Score) < -0.5).length;
                        
                        classPerf.innerHTML = `
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                                <div style="text-align: center; padding: 15px; background: #d1fae5; border-radius: 8px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #059669;">${above}</div>
                                    <div style="font-size: 14px; color: #047857;">Above Target</div>
                                </div>
                                <div style="text-align: center; padding: 15px; background: #fef3c7; border-radius: 8px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #d97706;">${onTrack}</div>
                                    <div style="font-size: 14px; color: #b45309;">On Track</div>
                                </div>
                                <div style="text-align: center; padding: 15px; background: #fee2e2; border-radius: 8px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #dc2626;">${below}</div>
                                    <div style="font-size: 14px; color: #991b1b;">Below Target</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    const recentStudents = document.getElementById('recentStudents');
                    if (state.students.length === 0) {
                        recentStudents.innerHTML = '<p style="color: var(--text-secondary);">No students yet.</p>';
                    } else {
                        recentStudents.innerHTML = state.students.slice(0, 3).map(s => {
                            const stats = calculateStudentP8(s.progress8);
                            return `
                                <div style="padding: 12px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600;">${s.name}</div>
                                        <div style="font-size: 13px; color: var(--text-secondary);">Year ${s.year} ‚Ä¢ P8: ${stats.p8Score}</div>
                                    </div>
                                    <button class="btn-primary" onclick="viewStudentP8(${s.id})" style="padding: 6px 12px; font-size: 12px;">View</button>
                                </div>
                            `;
                        }).join('');
                    }
                }
                
                const stats = calculateP8Stats();
                document.getElementById('p8Score').textContent = stats.p8Score;
                document.getElementById('avgTarget').textContent = stats.avgTarget;
                document.getElementById('avgCurrent').textContent = stats.avgCurrent;
                document.getElementById('totalPoints').textContent = stats.totalPoints;
                
                const p8List = document.getElementById('progress8List');
                p8List.innerHTML = Object.entries(state.progress8).map(([key, slot]) => {
                    const diff = getPointsDiff(slot.target, slot.current);
                    const diffClass = diff > 0 ? 'points-positive' : diff < 0 ? 'points-negative' : 'points-neutral';
                    
                    return `
                        <div class="p8-slot">
                            <div class="p8-header">
                                <input type="text" value="${slot.subject}" onchange="updateProgress8('${key}', 'subject', this.value)" placeholder="Subject name" style="font-weight: 600; border: 1px solid var(--border); padding: 8px; width: 70%;">
                                ${diff !== 0 ? `<span class="points-badge ${diffClass}">${diff > 0 ? '+' : ''}${diff} points</span>` : ''}
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label style="font-size: 12px; color: var(--text-secondary);">Target Grade</label>
                                    <select onchange="updateProgress8('${key}', 'target', this.value)" style="width: 100%; margin-top: 5px;">
                                        <option value="">-</option>
                                        ${[9,8,7,6,5,4,3,2,1].map(g => `<option value="${g}" ${slot.target == g ? 'selected' : ''}>${g} (${g} pts)</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--text-secondary);">Current Grade</label>
                                    <select onchange="updateProgress8('${key}', 'current', this.value)" style="width: 100%; margin-top: 5px;">
                                        <option value="">-</option>
                                        ${[9,8,7,6,5,4,3,2,1,'U'].map(g => `<option value="${g}" ${slot.current == g ? 'selected' : ''}>${g} (${gradePoints[g]} pts)</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                if (state.accountType === 'teacher') {
                    const studentsList = document.getElementById('studentsList');
                    if (state.students.length === 0) {
                        studentsList.innerHTML = '<p style="color: var(--text-secondary);">No students added. Click "Add Student" to begin.</p>';
                    } else {
                        studentsList.innerHTML = state.students.map(s => {
                            const studentStats = calculateStudentP8(s.progress8);
                            return `
                                <div class="student-row">
                                    <div>
                                        <div style="font-weight: 600; margin-bottom: 4px;">${s.name}</div>
                                        <div style="font-size: 13px; color: var(--text-secondary);">
                                            Year ${s.year} ‚Ä¢ P8: ${studentStats.p8Score} ‚Ä¢ Points: ${studentStats.totalPoints}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn-primary" onclick="viewStudentP8(${s.id})" style="padding: 8px 12px; font-size: 13px;">View P8</button>
                                        <button class="btn-danger" onclick="deleteStudent(${s.id})" style="padding: 8px 12px; font-size: 13px;">Delete</button>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }
                
                const subjectsList = document.getElementById('subjectsList');
                if (state.subjects.length === 0) {
                    subjectsList.innerHTML = '<p style="color: var(--text-secondary);">No subjects yet. Click "Add Subject" to get started!</p>';
                } else {
                    subjectsList.innerHTML = state.subjects.map(s => `
                        <div style="padding: 15px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 5px;">${s.name}</div>
                                ${s.teacher ? `<div style="font-size: 14px; color: var(--text-secondary);">Teacher: ${s.teacher}</div>` : ''}
                                ${s.target ? `<span class="grade-badge grade-${s.target}" style="margin-top: 8px;">Target: ${s.target}</span>` : ''}
                            </div>
                            <button class="btn-danger" onclick="deleteSubject(${s.id})" style="padding: 8px 12px; font-size: 14px;">Delete</button>
                        </div>
                    `).join('');
                }
                
                const topicsList = document.getElementById('topicsList');
                if (state.topics.length === 0) {
                    topicsList.innerHTML = '<p style="color: var(--text-secondary);">No topics yet. Click "Add Topic" to start tracking!</p>';
                } else {
                    const grouped = {};
                    state.topics.forEach(t => {
                        if (!grouped[t.subject]) grouped[t.subject] = [];
                        grouped[t.subject].push(t);
                    });
                    
                    topicsList.innerHTML = Object.entries(grouped).map(([subject, topics]) => `
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px; color: var(--accent);">${subject}</h4>
                            ${topics.map(t => `
                                <div style="padding: 12px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 500;">${t.name}</div>
                                        <div style="font-size: 14px; margin-top: 5px;">
                                            ${t.confidence === 'high' ? 'üòä High' : t.confidence === 'medium' ? 'üòê Medium' : 'üòü Low'} confidence
                                        </div>
                                    </div>
                                    <button class="btn-danger" onclick="deleteTopic(${t.id})" style="padding: 6px 10px; font-size: 12px;">Delete</button>
                                </div>
                            `).join('')}
                        </div>
                    `).join('');
                }
                
                const scheduleList = document.getElementById('scheduleList');
                if (state.schedule.length === 0) {
                    scheduleList.innerHTML = '<p style="color: var(--text-secondary);">No scheduled sessions. Click "Add Session" to plan your study time!</p>';
                } else {
                    scheduleList.innerHTML = state.schedule.map(s => `
                        <div style="padding: 15px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 5px;">${s.subject}</div>
                                <div style="font-size: 14px; color: var(--text-secondary);">
                                    üìÖ ${new Date(s.date).toLocaleDateString()} at ${s.time}
                                </div>
                                <div style="font-size: 14px; color: var(--text-secondary); margin-top: 3px;">
                                    ‚è±Ô∏è ${s.duration} minutes
                                </div>
                            </div>
                            <button class="btn-danger" onclick="deleteSchedule(${s.id})" style="padding: 8px 12px; font-size: 14px;">Delete</button>
                        </div>
                    `).join('');
                }
            }

        }, 1000);
    </script>
</body>
</html>
