<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5">
    <title>ReviseRight Pro - Production</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script src="https://js.stripe.com/v3/"></script>
    
    <style>
        /* Mobile Optimizations */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        html {
            -webkit-text-size-adjust: 100%;
            touch-action: manipulation;
        }
        
        body {
            overscroll-behavior-y: contain;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Improve button touch targets for mobile */
        button, a, input[type="submit"] {
            min-height: 44px; /* Apple's recommended touch target */
            min-width: 44px;
        }

        /* Better input focus for mobile */
        input:focus, textarea:focus, select:focus {
            font-size: 16px !important; /* Prevents zoom on iOS */
        }

        /* Smooth scrolling on mobile */
        .modal-content {
            -webkit-overflow-scrolling: touch;
        }

        /* Theme Variables */
        :root {
            --bg-primary: #f7f9fb;
            --bg-secondary: #ffffff;
            --bg-gradient-start: #eef2ff;
            --bg-gradient-end: #fae8ff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --accent-primary: #4f46e5;
            --accent-secondary: #7c3aed;
            --border-color: #e5e7eb;
            --card-bg: rgba(255, 255, 255, 0.95);
        }

        body.theme-dark {
            --bg-primary: #1f2937;
            --bg-secondary: #111827;
            --bg-gradient-start: #1f2937;
            --bg-gradient-end: #312e81;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --accent-primary: #818cf8;
            --accent-secondary: #a78bfa;
            --border-color: #374151;
            --card-bg: rgba(31, 41, 55, 0.95);
        }

        body.theme-dyslexia {
            --bg-primary: #fef3c7;
            --bg-secondary: #fffbeb;
            --bg-gradient-start: #fef3c7;
            --bg-gradient-end: #fde68a;
            --text-primary: #000000;
            --text-secondary: #1f2937;
            --accent-primary: #059669;
            --accent-secondary: #10b981;
            --border-color: #fbbf24;
            --card-bg: rgba(254, 249, 195, 0.95);
            font-family: 'Comic Sans MS', 'Arial', sans-serif;
            letter-spacing: 0.05em;
            line-height: 1.8;
        }

        /* --- Custom Themes --- */
        body.theme-blue {
            --bg-primary: #dbeafe;
            --bg-secondary: #eff6ff;
            --bg-gradient-start: #dbeafe;
            --bg-gradient-end: #bfdbfe;
            --text-primary: #1e3a8a;
            --text-secondary: #1e40af;
            --accent-primary: #2563eb;
            --accent-secondary: #3b82f6;
            --border-color: #93c5fd;
            --card-bg: rgba(239, 246, 255, 0.95);
        }

        body.theme-pink {
            --bg-primary: #fce7f3;
            --bg-secondary: #fef3f9;
            --bg-gradient-start: #fce7f3;
            --bg-gradient-end: #fbcfe8;
            --text-primary: #831843;
            --text-secondary: #9f1239;
            --accent-primary: #db2777;
            --accent-secondary: #ec4899;
            --border-color: #f9a8d4;
            --card-bg: rgba(254, 243, 249, 0.95);
        }
        /* --------------------- */


        body.font-small { font-size: 14px; }
        body.font-medium { font-size: 16px; }
        body.font-large { font-size: 18px; }
        body.font-xlarge { font-size: 20px; }

        body {
            background: linear-gradient(to bottom right, var(--bg-gradient-start), var(--bg-gradient-end));
            color: var(--text-primary);
            min-height: 100vh;
            min-height: -webkit-fill-available; /* iOS Safari */
        }

        .glass-effect {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        
        .gradient-text {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: var(--bg-secondary);
            margin: auto;
            padding: 0;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .tab-button.active {
            background-color: var(--accent-primary);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        /* Mobile-specific improvements */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                max-height: 85vh;
            }
            
            /* Larger touch targets on mobile */
            button {
                padding: 12px 16px;
            }
            
            /* Better spacing on small screens */
            .space-y-4 > * + * {
                margin-top: 1rem;
            }
        }

        /* Prevent iOS zoom on input focus */
        @supports (-webkit-touch-callout: none) {
            input, select, textarea {
                font-size: 16px !important;
            }
        }
    </style>
</head>
<body class="font-medium">
    <div id="loadingScreen" class="fixed inset-0 bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="text-6xl mb-4 animate-bounce">üìö</div>
            <h2 class="text-3xl font-bold text-white mb-2">ReviseRight Pro</h2>
            <p class="text-indigo-200">Connecting to Firebase...</p>
        </div>
    </div>

    <div id="authScreen" class="hidden fixed inset-0 bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center z-40">
        <div class="glass-effect rounded-3xl shadow-2xl p-8 max-w-md w-full mx-4" style="background: rgba(255,255,255,0.95)">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">üìö</div>
                <h1 class="text-3xl font-bold gradient-text mb-2">ReviseRight Pro</h1>
                <p class="text-gray-600">Your complete study companion</p>
            </div>

            <div id="loginForm">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Sign In</h2>
                <form onsubmit="handleLogin(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="loginEmail" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="your@email.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="loginPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button type="submit" class="w-full px-4 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg font-bold hover:shadow-lg transition-all">
                        Sign In
                    </button>
                </form>
                <p class="text-center text-sm text-gray-600 mt-4">
                    Don't have an account? 
                    <button onclick="showSignup()" class="text-indigo-600 font-semibold hover:underline">Sign Up</button>
                </p>
            </div>

            <div id="signupForm" class="hidden">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Create Account</h2>
                <form onsubmit="handleSignup(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                        <input type="text" id="signupName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Your name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="signupEmail" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="your@email.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="signupPassword" required minlength="6" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="At least 6 characters">
                    </div>
                    <button type="submit" class="w-full px-4 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg font-bold hover:shadow-lg transition-all">
                        Create Account
                    </button>
                </form>
                <p class="text-center text-sm text-gray-600 mt-4">
                    Already have an account? 
                    <button onclick="showLogin()" class="text-indigo-600 font-semibold hover:underline">Sign In</button>
                </p>
            </div>
        </div>
    </div>

    <div id="app" class="hidden"></div>
    
    <div id="settingsModal" class="modal">
        <div class="modal-content animate-fade-in">
            <div class="p-6">
                <h3 class="text-2xl font-bold mb-4" style="color: var(--text-primary)">‚öôÔ∏è App Settings</h3>
                <div class="space-y-6">
                    
                    <div>
                        <label class="block text-lg font-medium mb-2" style="color: var(--text-primary)">Theme</label>
                        <div class="grid grid-cols-3 md:grid-cols-5 gap-3">
                            <button onclick="updateSettings('theme', 'default')" class="p-3 rounded-lg text-sm font-medium border-2 hover:border-indigo-500 theme-btn" data-theme="default" style="background-color: #eef2ff; color: #111827;">Default</button>
                            <button onclick="updateSettings('theme', 'dark')" class="p-3 rounded-lg text-sm font-medium border-2 hover:border-indigo-500 theme-btn" data-theme="dark" style="background-color: #1f2937; color: #f9fafb;">Dark</button>
                            <button onclick="updateSettings('theme', 'dyslexia')" class="p-3 rounded-lg text-sm font-medium border-2 hover:border-indigo-500 theme-btn" data-theme="dyslexia" style="background-color: #fef3c7; color: #000000;">Dyslexia</button>
                            <button onclick="updateSettings('theme', 'blue')" class="p-3 rounded-lg text-sm font-medium border-2 hover:border-indigo-500 theme-btn" data-theme="blue" style="background-color: #dbeafe; color: #1e3a8a;">Blue</button>
                            <button onclick="updateSettings('theme', 'pink')" class="p-3 rounded-lg text-sm font-medium border-2 hover:border-indigo-500 theme-btn" data-theme="pink" style="background-color: #fce7f3; color: #831843;">Pink</button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-lg font-medium mb-2" style="color: var(--text-primary)">Font Size</label>
                        <div class="flex space-x-2">
                            <button onclick="updateSettings('fontSize', 'small')" class="px-3 py-2 rounded-lg text-sm font-medium border border-gray-300 hover:border-indigo-500 font-btn" data-size="small">A Small</button>
                            <button onclick="updateSettings('fontSize', 'medium')" class="px-3 py-2 rounded-lg font-medium border border-gray-300 hover:border-indigo-500 font-btn" data-size="medium">A Medium</button>
                            <button onclick="updateSettings('fontSize', 'large')" class="px-3 py-2 rounded-lg text-lg font-medium border border-gray-300 hover:border-indigo-500 font-btn" data-size="large">A Large</button>
                            <button onclick="updateSettings('fontSize', 'xlarge')" class="px-3 py-2 rounded-lg text-xl font-medium border border-gray-300 hover:border-indigo-500 font-btn" data-size="xlarge">A XL</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t" style="border-color: var(--border-color)">
                <button onclick="closeModal('settingsModal')" class="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>


    <script>
        // Multiple attempts to ensure Firebase loads on mobile
        function initializeApp() {
            // Check if Firebase loaded
            if (typeof firebase === 'undefined') {
                console.error('Firebase not loaded yet, retrying...');
                // Retry after a short delay
                setTimeout(initializeApp, 100);
                return;
            }

            console.log('‚úÖ Firebase loaded successfully!');

            try {
                // ============================================
                // FIREBASE CONFIGURATION (Placeholder keys)
                // ============================================
                const firebaseConfig = {
                    apiKey: "AIzaSyAyonlIqfTusq_ST6PKbzSED0s_HGRmA1o",
                    authDomain: "reviseright-pro.firebaseapp.com",
                    projectId: "reviseright-pro",
                    storageBucket: "reviseright-pro.firebasestorage.app",
                    messagingSenderId: "709040682753",
                    appId: "1:709040682753:web:645212006b33e06610cd00",
                    measurementId: "G-T6BNH4JP6Z"
                };

                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                window.auth = firebase.auth();
                window.db = firebase.firestore();
                console.log('‚úÖ Firebase initialized!');

                // Initialize Stripe (Placeholder Key)
                window.stripe = typeof Stripe !== 'undefined' ? Stripe('pk_test_YOUR_KEY_HERE') : null;

                // Start auth listener
                startApp();
            } catch (error) {
                console.error('Error initializing Firebase:', error);
                alert('Error loading app: ' + error.message);
            }
        }

        function startApp() {
            const auth = window.auth;
            const db = window.db;

        // ============================================
        // APPLICATION STATE
        // ============================================
        let currentUser = null;
        let state = {
            activeTab: 'dashboard',
            educationLevel: 'gcse',
            isPremium: false,
            isTeacher: false, // NEW: Teacher flag
            theme: 'default',
            fontSize: 'medium',
            subjects: [],
            topics: [],
            schedule: {},
            // Updated to track grade strings, which will be converted to points for display
            progress8: {
                englishLang: { target: '7', current: '6', subject: 'English Language (Dbl)' },
                maths: { target: '8', current: '7', subject: 'Maths (Dbl)' },
                ebacc1: { target: '6', current: '5', subject: 'History' },
                ebacc2: { target: '5', current: '4', subject: 'French' },
                ebacc3: { target: '6', current: '6', subject: 'Physics' },
                open1: { target: '7', current: '7', subject: 'Art & Design' },
                open2: { target: '5', current: '5', subject: 'Business Studies' },
                open3: { target: '4', current: '3', subject: 'Religious Studies' }
            }
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        // Converts a 9-1 GCSE grade string to Attainment 8 points
        function gradeToPoint(grade) {
            // Assumes 9-1 grading system for A8 points (9=9, 1=1)
            const point = parseInt(grade);
            return isNaN(point) ? 0 : point;
        }

        function calculateAttainment8Score() {
            let score = 0;
            const slots = [
                // Basket 1: English and Maths (Double-weighted = 4 slots)
                { key: 'englishLang', weight: 2 }, 
                { key: 'maths', weight: 2 },
                
                // Basket 2: EBacc (3 slots)
                { key: 'ebacc1', weight: 1 },
                { key: 'ebacc2', weight: 1 },
                { key: 'ebacc3', weight: 1 },
                
                // Basket 3: Open (3 slots)
                { key: 'open1', weight: 1 },
                { key: 'open2', weight: 1 },
                { key: 'open3', weight: 1 }
            ];

            // In a real app, you would need complex logic to correctly select the best 8 subjects
            // across the 3 baskets. Here, we calculate a score based on the 8 pre-defined slots.
            
            slots.forEach(slot => {
                const currentGrade = state.progress8[slot.key].current;
                const points = gradeToPoint(currentGrade);
                score += points * slot.weight;
            });

            return score;
        }


        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================
        
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                await window.auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                alert('‚ùå Login failed: ' + error.message);
            }
        }

        async function handleSignup(event) {
            event.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            
            try {
                const userCredential = await window.auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Simple check for 'teacher' account creation (e.g., via a special email domain)
                const isTeacher = email.endsWith('@revisedrightacademy.edu');
                
                await user.updateProfile({ displayName: name });
                
                await window.db.collection('users').doc(user.uid).set({
                    name: name,
                    email: email,
                    isPremium: isTeacher, // Teachers get premium in the demo
                    isTeacher: isTeacher, // Set teacher flag
                    educationLevel: 'gcse',
                    theme: 'default',
                    fontSize: 'medium',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('‚úÖ Account created! Welcome, ' + name + (isTeacher ? ' (Teacher)' : '') + '!');
            } catch (error) {
                alert('‚ùå Signup failed: ' + error.message);
            }
        }

        async function logout() {
            if (confirm('Are you sure you want to sign out?')) {
                try {
                    await window.auth.signOut();
                } catch (error) {
                    alert('Error signing out: ' + error.message);
                }
            }
        }

        // Listen for auth state changes
        function setupAuthListener() {
            window.auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = {
                        uid: user.uid,
                        email: user.email,
                        name: user.displayName || 'Student'
                    };
                    
                    await loadUserData();
                    hideAuthScreen();
                    document.getElementById('app').classList.remove('hidden');
                } else {
                    currentUser = null;
                    document.getElementById('loadingScreen').classList.add('hidden');
                    document.getElementById('authScreen').classList.remove('hidden');
                    document.getElementById('app').classList.add('hidden');
                }
            });
        }

        // ============================================
        // DATA MANAGEMENT
        // ============================================
        
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                const doc = await window.db.collection('users').doc(currentUser.uid).get();
                
                if (doc.exists) {
                    const data = doc.data();
                    state.educationLevel = data.educationLevel || 'gcse';
                    state.isPremium = data.isPremium || false;
                    state.isTeacher = data.isTeacher || false; // Load teacher flag
                    state.theme = data.theme || 'default';
                    state.fontSize = data.fontSize || 'medium';
                    state.subjects = data.subjects || [];
                    state.topics = data.topics || [];
                    state.schedule = data.schedule || {};
                    state.progress8 = data.progress8 || state.progress8;
                }
                
                applyTheme();
                render();
            } catch (error) {
                console.error('Error loading data:', error);
                render();
            }
        }

        async function saveToCloud() {
            if (!currentUser) return;
            
            try {
                // Prepare minimal state for saving
                const dataToSave = {
                    subjects: state.subjects,
                    topics: state.topics,
                    schedule: state.schedule,
                    educationLevel: state.educationLevel,
                    theme: state.theme,
                    fontSize: state.fontSize,
                    progress8: state.progress8,
                    isPremium: state.isPremium,
                    isTeacher: state.isTeacher,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                };

                await window.db.collection('users').doc(currentUser.uid).update(dataToSave);
                
                showSyncIndicator();
            } catch (error) {
                console.error('Error saving:', error);
            }
        }

        // Auto-save every 30 seconds
        setInterval(() => {
            if (currentUser) saveToCloud();
        }, 30000);

        // ============================================
        // UI & SETTINGS
        // ============================================
        
        function updateSettings(key, value) {
            state[key] = value;
            applyTheme(); // Re-apply theme/font immediately
            saveToCloud();
            
            // Highlight active button in modal
            document.querySelectorAll(`.${key}-btn`).forEach(btn => {
                if (btn.dataset[key] === value) {
                    btn.classList.add('ring-2', 'ring-offset-2', 'ring-indigo-500');
                    btn.style.borderColor = 'var(--accent-primary)';
                } else {
                    btn.classList.remove('ring-2', 'ring-offset-2', 'ring-indigo-500');
                    btn.style.borderColor = '#d1d5db';
                }
            });

            if (key !== 'fontSize' && key !== 'theme') {
                render(); // Re-render main content if necessary
            }
        }

        function showSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.add('show');
            
            // Set initial highlights in the modal
            updateSettings('theme', state.theme);
            updateSettings('fontSize', state.fontSize);
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        function showSyncIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            indicator.innerHTML = '‚òÅÔ∏è Synced!';
            document.body.appendChild(indicator);
            setTimeout(() => indicator.remove(), 2000);
        }

        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('signupForm').classList.add('hidden');
        }

        function showSignup() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
        }

        function hideAuthScreen() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        function applyTheme() {
            // Reset all theme classes
            document.body.className = '';
            
            // Apply theme class
            if (state.theme && state.theme !== 'default') {
                document.body.classList.add(`theme-${state.theme}`);
            }
            
            // Apply font size class
            document.body.classList.add(`font-${state.fontSize || 'medium'}`);
        }

        // ============================================
        // COMPONENT RENDERING
        // ============================================

        function renderProgress8Dashboard() {
            const attainment8Score = calculateAttainment8Score();
            
            // Convert progress8 object to an array for easy iteration in the template
            const slots = Object.keys(state.progress8).map(key => ({
                ...state.progress8[key],
                key: key,
                points: gradeToPoint(state.progress8[key].current),
                isDoubleWeighted: key === 'englishLang' || key === 'maths',
                basket: key.startsWith('ebacc') ? 'EBacc' : (key.startsWith('open') ? 'Open' : 'Core')
            }));

            // Calculate progress status (example logic)
            const overallProgress = attainment8Score; // Simplified for demo, actual P8 is A8 - Estimated A8.

            return `
                <div class="glass-effect rounded-2xl shadow-xl p-6 mb-6 animate-fade-in">
                    <h2 class="text-2xl font-bold mb-4 gradient-text">Progress 8 & Attainment 8 Tracker</h2>
                    <p style="color: var(--text-secondary)" class="mb-4">
                        This view tracks your performance across the 8 subject slots (10 point slots total) used for Attainment 8.
                    </p>

                    <div class="p-4 rounded-xl mb-6 flex justify-between items-center" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                        <div>
                            <p class="text-sm font-semibold" style="color: var(--text-secondary)">Current Attainment 8 Score (Max 90)</p>
                            <div class="text-4xl font-extrabold gradient-text">${attainment8Score.toFixed(0)}</div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-semibold" style="color: var(--text-secondary)">Progress 8 Estimate</p>
                            <div class="text-2xl font-bold text-green-600">+0.25</div>
                            <p class="text-xs" style="color: var(--text-secondary)">(Above National Average)</p>
                        </div>
                    </div>

                    <h3 class="text-xl font-bold mb-3" style="color: var(--text-primary)">Subject Slots (8/10)</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                        ${slots.map(slot => `
                            <div class="p-4 rounded-lg flex justify-between items-center transition-shadow border" 
                                style="background-color: var(--bg-secondary); border-color: var(--border-color); box-shadow: 0 1px 3px 0 rgba(0,0,0,0.05);">
                                <div>
                                    <p class="text-sm font-medium" style="color: var(--text-primary)">
                                        ${slot.subject}
                                    </p>
                                    <p class="text-xs" style="color: var(--text-secondary)">
                                        Basket: ${slot.basket} ${slot.isDoubleWeighted ? '(x2)' : ''}
                                    </p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm" style="color: var(--text-secondary)">Grade</p>
                                    <p class="text-2xl font-bold ${slot.points >= gradeToPoint(slot.target) ? 'text-green-500' : 'text-red-500'}">
                                        ${slot.current}
                                    </p>
                                    <p class="text-xs" style="color: var(--text-secondary)">
                                        (${slot.points} Pts)
                                    </p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="mt-6 text-center">
                        <button onclick="saveToCloud()" class="px-6 py-3 bg-indigo-500 text-white rounded-lg font-bold hover:bg-indigo-600 transition-colors">
                            Update Grades
                        </button>
                    </div>
                </div>
            `;
        }

        function renderTeacherDashboard() {
            return `
                <div class="glass-effect rounded-2xl shadow-xl p-6 mb-6 animate-fade-in">
                    <h2 class="text-2xl font-bold mb-4 text-green-600">üçé Teacher Dashboard</h2>
                    <p style="color: var(--text-secondary)" class="mb-6">
                        Welcome, ${currentUser.name}. This view is active for your school license.
                    </p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-6 rounded-xl border-2 border-green-200" style="background-color: var(--bg-secondary);">
                            <h3 class="text-xl font-bold text-green-700 mb-2">School Progress 8</h3>
                            <p class="text-4xl font-extrabold text-green-500">+0.12</p>
                            <p class="text-sm text-gray-500 mt-2">Target: +0.05. Cohort A8: 48.2</p>
                            <p class="text-xs mt-1 text-green-600">‚úÖ Meeting DfE floor standards.</p>
                        </div>

                        <div class="p-6 rounded-xl border-2 border-yellow-200" style="background-color: var(--bg-secondary);">
                            <h3 class="text-xl font-bold text-yellow-700 mb-2">Class Gaps Identified</h3>
                            <ul class="list-disc list-inside text-sm space-y-1">
                                <li>42% struggle with Topic: Photosynthesis.</li>
                                <li>12 students behind on revision schedule.</li>
                                <li>Action: Assign remedial quiz to Year 10 Group B.</li>
                            </ul>
                        </div>
                    </div>

                    <div class="mt-8 text-center">
                        <button class="px-6 py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition-colors">
                            View Full Student Analytics
                        </button>
                    </div>
                </div>
            `;
        }

        function renderStudentApp() {
            // Default content
            let content = `
                <div class="glass-effect rounded-2xl shadow-xl p-8 text-center animate-fade-in">
                    <div class="text-6xl mb-4">üéâ</div>
                    <h2 class="text-2xl font-bold mb-4" style="color: var(--text-primary)">
                        Firebase Connected Successfully!
                    </h2>
                    <p class="mb-6" style="color: var(--text-secondary)">
                        Your ReviseRight Pro is now running on Firebase. <br>
                        Real authentication and cloud database are active!
                    </p>
                    <button onclick="changeTab('progress8')" class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition-colors">
                        View Progress 8 Tracker
                    </button>
                </div>
            `;
            
            // Render specific tab content
            if (state.activeTab === 'progress8') {
                content = renderProgress8Dashboard();
            } else if (state.activeTab === 'teacher') {
                content = renderTeacherDashboard();
            }

            return content;
        }

        function changeTab(tabName) {
            state.activeTab = tabName;
            render();
        }

        function render() {
            if (!currentUser) return;
            
            // Dynamic Header Buttons
            const premiumButton = !state.isPremium ? `
                <button onclick="upgradeToPremium('monthly')" class="px-4 py-2 bg-gradient-to-r from-yellow-400 to-yellow-500 text-yellow-900 rounded-lg font-bold text-sm">
                    ‚≠ê Upgrade
                </button>
            ` : '';

            const teacherButton = state.isTeacher ? `
                <button onclick="changeTab('teacher')" class="px-4 py-2 bg-green-500 text-white rounded-lg font-bold text-sm hover:bg-green-600">
                    üßë‚Äçüè´ Teacher Dashboard
                </button>
            ` : '';
            
            // Render the main application shell
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen p-4">
                    <div class="max-w-7xl mx-auto">
                        <div class="glass-effect rounded-2xl shadow-xl p-6 mb-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h1 class="text-3xl font-bold gradient-text">ReviseRight Pro</h1>
                                    <p style="color: var(--text-secondary)">
                                        ${currentUser.name} ‚Ä¢ ${state.isPremium ? '‚≠ê Premium' : 'Free'}
                                    </p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    ${teacherButton}
                                    ${premiumButton}
                                    <button onclick="showSettings()" class="p-3 bg-gray-200 rounded-lg font-semibold hover:bg-gray-300">
                                        ‚öôÔ∏è
                                    </button>
                                    <button onclick="logout()" class="px-4 py-2 bg-gray-200 rounded-lg font-semibold text-sm hover:bg-gray-300">
                                        Sign Out
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="mb-6 flex space-x-2 p-2 rounded-xl glass-effect">
                            <button onclick="changeTab('dashboard')" class="tab-button px-4 py-2 rounded-lg font-semibold text-sm transition-colors ${state.activeTab === 'dashboard' ? 'active' : 'bg-transparent'}" style="color: ${state.activeTab === 'dashboard' ? 'white' : 'var(--text-primary)'}">
                                Home
                            </button>
                            <button onclick="changeTab('progress8')" class="tab-button px-4 py-2 rounded-lg font-semibold text-sm transition-colors ${state.activeTab === 'progress8' ? 'active' : 'bg-transparent'}" style="color: ${state.activeTab === 'progress8' ? 'white' : 'var(--text-primary)'}">
                                Progress 8
                            </button>
                            <button onclick="changeTab('revision')" class="tab-button px-4 py-2 rounded-lg font-semibold text-sm transition-colors ${state.activeTab === 'revision' ? 'active' : 'bg-transparent'}" style="color: ${state.activeTab === 'revision' ? 'white' : 'var(--text-primary)'}">
                                Revision Planner
                            </button>
                            </div>
                        
                        ${renderStudentApp()}

                    </div>
                </div>
            `;
            
            // Re-render Teacher Dashboard if it's the active tab
            if (state.activeTab === 'teacher') {
                // Rerender Teacher Dashboard to avoid flicker if it was already active
                document.querySelector('.min-h-screen > .max-w-7xl').children[2].innerHTML = renderTeacherDashboard();
            }
        }

        // ============================================
        // PAYMENT FUNCTIONS
        // ============================================
        
        async function upgradeToPremium(plan) {
            alert('üí≥ Payment integration coming soon!\n\nFor demo: Upgrading to Premium ' + plan);
            
            try {
                await window.db.collection('users').doc(currentUser.uid).update({
                    isPremium: true,
                    plan: plan,
                    upgradeDate: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                state.isPremium = true;
                render();
                alert('üéâ Demo upgrade successful! Premium features unlocked.');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Set up auth listener
        setupAuthListener();
        
        console.log('üî• App ready!');
        } // End startApp function

        // Start initialization when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>
